/*!
    @preserve

 	DPF javascript implementation

 	@author Bruno Fanini
	VHLab, CNR ITABC

	When using this JS library, add also reference to EG publication:

	@inproceedings {gch.20161380,
		booktitle = {Eurographics Workshop on Graphics and Cultural Heritage},
		editor = {Chiara Eva Catalano and Livio De Luca},
		title = {{A Framework for Compact and Improved Panoramic VR Dissemination}},
		author = {Fanini, Bruno and D'Annibale, Enzo},
		year = {2016},
		publisher = {The Eurographics Association},
		ISSN = {2312-6124},
		ISBN = {978-3-03868-011-6},
		DOI = {10.2312/gch.20161380}
	}

==================================================================================*/
"use strict";var OSG=window.OSG,osg=OSG.osg;OSG.globalify();const DPF_RAD_SCALE=100,DPF_ANN_HASH=.3,DPF_PANO_UNIT=0,DPF_DEPTH_UNIT=1,DPF_ANN_UNIT=2,DPF_RAD2DEG=180/Math.PI,DPF_DEG2RAD=Math.PI/180;var DPFutils={};DPFutils.videoExts=["mp4","avi","ogg","ogv","webm","mpd"],DPFutils.getFileExtension=function(t){return t.substr(t.lastIndexOf(".")+1).toLowerCase()},DPFutils.isURLvideo=function(t){for(var e=this.getFileExtension(t),i=0;i<DPFutils.videoExts.length;i++){var a=DPFutils.videoExts[i];if(e==a.toLowerCase())return!0}return!1},DPFutils.bkIM=new window.Image,DPFutils.bkIM.src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNg+A8AAQIBANEay48AAAAASUVORK5CYII=",DPFutils.wIM=new window.Image,DPFutils.wIM.src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAC0lEQVQIW2P8DwQACgAD/il4QJ8AAAAASUVORK5CYII=",DPFutils.fallbackBlackTex=new osg.Texture,DPFutils.fallbackBlackTex.setImage(DPFutils.bkIM),DPFutils.fallbackBlackTex.setMinFilter(osg.Texture.LINEAR),DPFutils.fallbackBlackTex.setMagFilter(osg.Texture.LINEAR),DPFutils.fallbackBlackTex.setWrapS(osg.Texture.REPEAT),DPFutils.fallbackBlackTex.setWrapT(osg.Texture.REPEAT),DPFutils.fallbackWhiteTex=new osg.Texture,DPFutils.fallbackWhiteTex.setImage(DPFutils.wIM),DPFutils.fallbackWhiteTex.setMinFilter(osg.Texture.LINEAR),DPFutils.fallbackWhiteTex.setMagFilter(osg.Texture.LINEAR),DPFutils.fallbackWhiteTex.setWrapS(osg.Texture.REPEAT),DPFutils.fallbackWhiteTex.setWrapT(osg.Texture.REPEAT);var DPF=function(t,e,i){this._uniqueName="",this._position=[0,0,0],this._mOrient=void 0,this._vOrient=[0,0,0],this._mainTrans=new osg.MatrixTransform,this._mainTrans.getOrCreateStateSet().setRenderingHint("TRANSPARENT_BIN"),this._mainTrans.getOrCreateStateSet().setAttributeAndModes(new osg.BlendFunc,osg.StateAttribute.ON|osg.StateAttribute.OVERRIDE),this._glslProgram=void 0,this.initUniforms(),this._useUnifiedLayout=!1,this._panoPath="",this._panoPathLow="",this._depthPath="",this._annPath="",this._isPanoVid=!1,this._isDepthVid=!1,this._isAnnVid=!1,this._panoVidElem=void 0,this._depthVidElem=void 0,this._annVidElem=void 0,this._depthRange={min:0,max:.01},this._baseGeom=void 0,this._maxBoundSphere=void 0,this._baseGeomResolution=128,this.realizeBaseSphere(),this._bLoading=[!1,!1,!1],this._annotationList=[],void 0!==t&&this.requestPano(t),void 0!==e&&this.requestDepth(e),void 0!==i&&this.requestAnnotation(i)};DPF.prototype={setUniqueName:function(t){this._uniqueName=t},getUniqueName:function(){return this._uniqueName},setPanoPath:function(t,e){this._panoPath=t,void 0!==e&&(this._panoPathLow=e),DPFutils.isURLvideo(t)&&(this._isPanoVid=!0,console.log("Detected pano video stream"))},getPanoPath:function(){return this._panoPath},setDepthPath:function(t){this._depthPath=t,DPFutils.isURLvideo(t)&&(this._isDepthVid=!0,console.log("Detected depth video stream"))},getDepthPath:function(){return this._depthPath},setAnnotationPath:function(t){this._annPath=t},getAnnotationPath:function(){return this._annPath},isLoading:function(){return this._bLoading[0]||this._bLoading[1]||this._bLoading[2]},setPosition:function(t){this._position=t,this.updateMatrixTransform()},getPosition:function(){return this._position},setOrientationFromQuaternion:function(t){this._orientation=t,this.updateMatrixTransform()},setOrientationFromEulerVector:function(t){this._mOrient=osg.Matrix.create();var e=osg.Matrix.create();osg.Matrix.makeRotate(t[0],1,0,0,e);var i=osg.Matrix.create();osg.Matrix.makeRotate(t[1],0,1,0,i);var a=osg.Matrix.create();osg.Matrix.makeRotate(t[2],0,0,1,a),this._mOrient=e,osg.Matrix.preMult(this._mOrient,i),osg.Matrix.preMult(this._mOrient,a),this._vOrient[0]=t[0],this._vOrient[1]=t[1],this._vOrient[2]=t[2],this.updateMatrixTransform()},getOrientation:function(){return this._vOrient},getTransNode:function(){return this._mainTrans},setDepthRange:function(t,e){this._depthRange.min=t/DPF_RAD_SCALE,this._depthRange.max=e/DPF_RAD_SCALE,this._mainTrans.getOrCreateStateSet().getUniform("minRad").setFloat(this._depthRange.min),this._mainTrans.getOrCreateStateSet().getUniform("maxRad").setFloat(this._depthRange.max),this._dErr=((e-t)/256).toFixed(3),console.log("- DPF max depth error: "+this._dErr)},getDepthRange:function(){var t=[this._depthRange.min*DPF_RAD_SCALE,this._depthRange.max*DPF_RAD_SCALE];return t},setDepthMultiplier:function(t){this._mainTrans.getOrCreateStateSet().getUniform("radMult").setFloat(t)},getDepthMultiplier:function(){return this._mainTrans.getOrCreateStateSet().getUniform("radMult").getInternalArray()[0]},getDepthErrorAtDistance:function(t){var e=this._depthRange.min*DPF_RAD_SCALE,i=this._depthRange.max*DPF_RAD_SCALE;if(e>=t)return 0;if(t>i)return this._dErr;var a=(t-e)/(i-e),s=this._dErr;return s*=this.getQuadraticDepth()?a*a:a,s.toFixed(6)},setVisibility:function(t){this._mainTrans.getOrCreateStateSet().getUniform("visibility").setFloat(t)},getVisibility:function(){return this._mainTrans.getOrCreateStateSet().getUniform("visibility").getInternalArray()[0]},setDiscardFactor:function(t){this._mainTrans.getOrCreateStateSet().getUniform("slopeDiscard").setFloat(t)},getDiscardFactor:function(){return this._mainTrans.getOrCreateStateSet().getUniform("slopeDiscard").getInternalArray()[0]},setQuadraticDepth:function(t){this._mainTrans.getOrCreateStateSet().getUniform("bQuadratic").setInt(t)},toggleQuadraticDepth:function(){var t=this._mainTrans.getOrCreateStateSet().getUniform("bQuadratic").getInternalArray()[0];this._mainTrans.getOrCreateStateSet().getUniform("bQuadratic").setInt(1===t?0:1)},getQuadraticDepth:function(){return this._mainTrans.getOrCreateStateSet().getUniform("bQuadratic").getInternalArray()[0]},toggleInvertDepth:function(){var t=this._mainTrans.getOrCreateStateSet().getUniform("bInvertDM").getInternalArray()[0];this._mainTrans.getOrCreateStateSet().getUniform("bInvertDM").setInt(1===t?0:1)},getInvertDepth:function(){return this._mainTrans.getOrCreateStateSet().getUniform("bInvertDM").getInternalArray()[0]},setGLSLprogram:function(t){void 0!==t&&(this._glslProgram=t,this._mainTrans.getOrCreateStateSet().setAttributeAndModes(t))},getGLSLprogram:function(){return this._glslProgram},initUniforms:function(){var t=this._mainTrans.getOrCreateStateSet();t.addUniform(osg.Uniform.createInt1(DPF_PANO_UNIT,"panoTex")),t.addUniform(osg.Uniform.createInt1(DPF_DEPTH_UNIT,"depthTex")),t.addUniform(osg.Uniform.createInt1(DPF_ANN_UNIT,"annTex")),t.addUniform(osg.Uniform.createFloat1(0,"minRad")),t.addUniform(osg.Uniform.createFloat1(.01,"maxRad")),t.addUniform(osg.Uniform.createFloat1(1,"radMult")),t.addUniform(osg.Uniform.createFloat1(1,"visibility")),t.addUniform(osg.Uniform.createFloat1(0,"slopeDiscard")),t.addUniform(osg.Uniform.createFloat1(256,"annotationWidth")),t.addUniform(osg.Uniform.createFloat3([0,0,0],"camPos")),t.addUniform(osg.Uniform.createFloat3([0,0,0],"panoPos")),t.addUniform(osg.Uniform.createInt1(1,"bQuadratic")),t.addUniform(osg.Uniform.createInt1(0,"bInvertDM")),t.addUniform(osg.Uniform.createInt1(1,"bActive"))},updateMatrixTransform:function(){var t=osg.Matrix.create();void 0!==this._mOrient&&osg.Matrix.preMult(t,this._mOrient);var e=osg.Matrix.create();osg.Matrix.makeScale(DPF_RAD_SCALE,DPF_RAD_SCALE,DPF_RAD_SCALE,e),osg.Matrix.preMult(t,e),osg.Matrix.setTrans(t,this._position[0],this._position[1],this._position[2]),console.log("Updated DPF Position: "+this._position),this._mainTrans.setMatrix(t)},realizeBaseSphere:function(){this._mainTrans.setCullingActive(!1),this.updateMatrixTransform(),this._baseGeom=osg.createTexturedSphere(1,this._baseGeomResolution,this._baseGeomResolution),this._baseGeom.setCullingActive(!1),this._baseGeom.getOrCreateStateSet().setAttributeAndModes(new osg.CullFace("DISABLE"));var t=osg.Matrix.create();osg.Matrix.makeRotate(-Math.PI/2,1,0,0,t),this._baseGeomT=new osg.MatrixTransform,this._baseGeomT.setMatrix(t),this._baseGeomT.setCullingActive(!1),this._baseGeomT.addChild(this._baseGeom),this._mainTrans.addChild(this._baseGeomT)},requestPano:function(t){var e=this;if(e._bLoading[0]=!0,void 0!==t&&e.setPanoPath(t),e._isPanoVid){e._panoVidElem=document.createElement("video"),e._panoVidElem.style.display="none";var i=new osg.ImageStream(e._panoVidElem);e._panoVidElem.preload="auto",e._panoVidElem.loop=!0,e._panoVidElem.crossOrigin="anonymous",e._panoVidElem.src=e._panoPath,i.whenReady().then(function(t){var a=new osg.Texture;a.setImage(i),a.setMinFilter(osg.Texture.LINEAR),a.setMagFilter(osg.Texture.LINEAR),a.setWrapS(osg.Texture.REPEAT),a.setWrapT(osg.Texture.CLAMP_TO_EDGE),a.setFlipY(!1),e._mainTrans.getOrCreateStateSet().setTextureAttributeAndModes(DPF_PANO_UNIT,a),console.log("Videopano "+e._panoPath+" loaded."),e._bLoading[0]=!1,t.play()}.bind(e))}else{var a=new osg.Texture,s=function(t,i){osgDB.readImageURL(t).then(function(s){a.setImage(s),a.setMinFilter(osg.Texture.LINEAR_MIPMAP_LINEAR),a.setMagFilter(osg.Texture.LINEAR),a.setWrapS(osg.Texture.REPEAT),a.setWrapT(osg.Texture.CLAMP_TO_EDGE),a.setFlipY(!1),e._mainTrans.getOrCreateStateSet().setTextureAttributeAndModes(DPF_PANO_UNIT,a),console.log("Pano texture "+t+" loaded."),i()})};s(e._panoPath,function(){e._bLoading[0]=!1})}},requestDepth:function(t){if(!this._useUnifiedLayout){var e=this;if(e._bLoading[1]=!0,void 0!==t&&e.setDepthPath(t),e._isDepthVid){e._depthVidElem=document.createElement("video"),e._depthVidElem.style.display="none";var i=new osg.ImageStream(e._depthVidElem);e._depthVidElem.preload="auto",e._depthVidElem.loop=!0,e._depthVidElem.crossOrigin="anonymous",e._depthVidElem.src=e._depthPath,i.whenReady().then(function(t){var a=new osg.Texture;a.setImage(i),a.setMinFilter(osg.Texture.LINEAR),a.setMagFilter(osg.Texture.LINEAR),a.setWrapS(osg.Texture.REPEAT),a.setWrapT(osg.Texture.CLAMP_TO_EDGE),a.setFlipY(!1),e._mainTrans.getOrCreateStateSet().setTextureAttributeAndModes(DPF_DEPTH_UNIT,a),console.log("VideoDepth "+e._depthPath+" loaded."),e._bLoading[1]=!1,t.play()}.bind(e))}else osgDB.readImageURL(e._depthPath).then(function(t){var i=new osg.Texture;i.setImage(t),i.setMinFilter(osg.Texture.LINEAR_MIPMAP_LINEAR),i.setMagFilter(osg.Texture.LINEAR),i.setWrapS(osg.Texture.REPEAT),i.setWrapT(osg.Texture.CLAMP_TO_EDGE),i.setFlipY(!1),e._mainTrans.getOrCreateStateSet().setTextureAttributeAndModes(DPF_DEPTH_UNIT,i),console.log("Depth texture "+e._depthPath+" loaded."),e._bLoading[1]=!1})}},requestAnnotation:function(t){if(!this._useUnifiedLayout){var e=this;e._bLoading[2]=!0,void 0!==t&&e.setAnnotationPath(t),osgDB.readImageURL(e._annPath).then(function(t){var i=new osg.Texture;i.setImage(t),i.setMinFilter("NEAREST"),i.setMagFilter("NEAREST"),i.setWrapS(osg.Texture.REPEAT),i.setWrapT(osg.Texture.CLAMP_TO_EDGE),i.setFlipY(!1),e._mainTrans.getOrCreateStateSet().setTextureAttributeAndModes(DPF_ANN_UNIT,i),console.log("Annotation texture "+e._annPath+" loaded."),e._bLoading[2]=!1})}},playVideoStreams:function(){void 0!==this._panoVidElem&&this._panoVidElem.play(),void 0!==this._depthVidElem&&this._depthVidElem.play(),void 0!==this._annVidElem&&this._annVidElem.play(),this._isVideoStreamOnPlay=!0},pauseVideoStreams:function(){void 0!==this._panoVidElem&&this._panoVidElem.pause(),void 0!==this._depthVidElem&&this._depthVidElem.pause(),void 0!==this._annVidElem&&this._annVidElem.pause(),this._isVideoStreamOnPlay=!1},isPlayingVideoStreams:function(){return this._isVideoStreamOnPlay},playOrPauseVideoStreams:function(){this._isVideoStreamOnPlay?this.pauseVideoStreams():this.playVideoStreams()},syncVideoStreams:function(){if(void 0!==this._panoVidElem){var t=this._panoVidElem.currentTime;void 0!==this._depthVidElem&&(this._depthVidElem.currentTime=t),void 0!==this._annVidElem&&(this._annVidElem.currentTime=t)}},registerAnnotation:function(t,e,i){var a=new DPFannotation(this,t);void 0!==e&&(a.onHover=e),void 0!==i&&(a.onSelect=i),this._annotationList.push(a)}};var DPFannotation=function(t,e){var i=this;i.dpf=t,i.hashID=e,i.onHover=function(){console.log("Hovering annotation #"+i.hashID)},i.onSelect=function(){console.log("Selected annotation #"+i.hashID)}},DPFupdateCallback=function(t){this._dpfh=t};DPFupdateCallback.prototype={update:function(t,e){var i=this._dpfh,a=e.getFrameStamp().getSimulationTime(),s=a-i._time;if(0>s)return!0;if(i._time=a,i._stdVisionGroup.getOrCreateStateSet().getUniform("time").setFloat(a),0==i._dpfList.length)return!0;if(i._manip.getEyePosition(i._eyePos),osg.Vec3.add(i._eyePos,i._manip._direction,i._targPos),void 0!==i._pointerTrans){var o=osg.Vec3.create(),n=.98*i._hoverAnnDepth,r=[n,n,n];r[0]=r[0]*i._manip._direction[0],r[1]=r[1]*i._manip._direction[1],r[2]=r[2]*i._manip._direction[2],osg.Vec3.add(i._eyePos,r,o),i._pointerTrans.setPosition(o)}for(var h=999999,d=osg.Vec3.create(),_=999999,g=osg.Vec3.create(),l=0;l<i._dpfList.length;l++){var u=i._dpfList[l],c=u.getPosition();u.setVisibility(0),osg.Vec3.sub(i._eyePos,c,g);var p=osg.Vec3.length2(g);if(p>1){osg.Vec3.normalize(g,g);var m=osg.Vec3.dot(i._manip._direction,g);-.8>m&&_>p&&(i._inviewDPFid=l,_=p)}var T=osg.vec3.create();osg.Vec3.lerp(.1,i._eyePos,i._pointerTrans.getPosition(),T),osg.Vec3.sub(T,c,d);var v=osg.Vec3.length2(d);h>v&&(h=v,i._closestDPF=u,i._closestDPFid=l)}if(i._closestDPF.setVisibility(1),i._tMoveReq>=0){var f=(a-i._tMoveReq)/i._tMoveDur;if(f>=1)i._tMoveReq=-1;else{f=(1-Math.cos(f*Math.PI))/2;var P=osg.Vec3.create();osg.Vec3.lerp(f,i._reqFrom,i._reqTo,P),i._manip.setEyePosition(P),i._eyePos=P}}return void 0!==i.onTick&&i.onTick(),!0}};var DPFhandler=function(t,e){return void 0===t?void console.log("Canvas not valid"):(this._canvas=t,this._viewer=void 0===e?void 0:e,this._dpfList=[],this._root=new osg.Node,this._dpfGroup=new osg.Node,this._stdVisionGroup=new osg.Node,this._annVisionGroup=new osg.Node,this._annVisionGroup.getOrCreateStateSet().setAttributeAndModes(new osg.Depth(osg.Depth.ENABLE),osg.StateAttribute.ON|osg.StateAttribute.OVERRIDE),this._annVisionGroup.getOrCreateStateSet().setAttributeAndModes(new osg.CullFace(osg.CullFace.FRONT),osg.StateAttribute.ON|osg.StateAttribute.OVERRIDE),this._annVisionGroup.getOrCreateStateSet().setAttributeAndModes(new osg.BlendFunc,osg.StateAttribute.OFF|osg.StateAttribute.OVERRIDE),this._annVisionGroup.getOrCreateStateSet().setRenderingHint("OPAQUE_BIN"),this._stdVisionGroup.getOrCreateStateSet().setAttributeAndModes(new osg.BlendFunc,osg.StateAttribute.ON|osg.StateAttribute.OVERRIDE),this._stdVisionGroup.getOrCreateStateSet().setAttributeAndModes(new osg.CullFace(osg.CullFace.FRONT),osg.StateAttribute.ON|osg.StateAttribute.OVERRIDE),this._stdVisionGroup.getOrCreateStateSet().setRenderingHint("TRANSPARENT_BIN"),this._stdVisionGroup.getOrCreateStateSet().setBinNumber(11),this._dpfGroup.addChild(this._stdVisionGroup),this._stdVisionGroup.getOrCreateStateSet().addUniform(osg.Uniform.createInt1(0,"bAnnotationVision")),this._stdVisionGroup.getOrCreateStateSet().addUniform(osg.Uniform.createInt1(0,"annotationHash")),this._stdVisionGroup.getOrCreateStateSet().addUniform(osg.Uniform.createFloat1(0,"time")),this._annVisionGroup.getOrCreateStateSet().addUniform(osg.Uniform.createInt1(1,"bAnnotationVision")),this._annVisionGroup.getOrCreateStateSet().addUniform(osg.Uniform.createInt1(0,"bDepthVision")),this._useUnifiedLayout=!1,this._annXYquery=[.5,.5],this.create3Dpointer(),this.onHoverAnnotation=void 0,this.onLeaveAnnotation=void 0,this.onTick=void 0,this._root.addChild(this._dpfGroup),this._shadersPath=void 0,this._glslProgram=void 0,this._manip=new osgGA.FirstPersonManipulator,this._manip.setNode(this._dpfGroup),this._manip.setEyePosition([0,0,0]),this._manip.setTarget([1,0,0]),this._manip.setDelay(1),this._manip.setStepFactor(.01),this._eyePos=[0,0,0],this._targPos=[1,0,0],this._fov=60,this._reqFrom=osg.Vec3.create(),this._reqTo=osg.Vec3.create(),this._tMoveReq=-1,this._tMoveDur=3,this._closestDPF=void 0,this._closestDPFid=-1,this._inviewDPFid=-1,this.setupFallbacks(),this._vrState=!1,void(this._vrNode=void 0))};DPFhandler.prototype={run:function(){return void 0===this._canvas?void console.log("ERROR: you must provide a canvas element"):(void 0===this._viewer&&(this._viewer=new osgViewer.Viewer(this._canvas,{antialias:!1,overrideDevicePixelRatio:1,enableFrustumCulling:!1,alpha:!0,scrollwheel:!1})),this._viewer.init(),this._viewer.setLightingMode(osgViewer.View.LightingMode.NO_LIGHT),this._viewer.setSceneData(this._root),this._viewer.getCamera().setNearFarRatio(.001),this._viewer.setManipulator(this._manip),this.setFOV(this._fov),this._viewer.run(),this.attachListeners(),this._aRTTsize=[256,256],this._hoverAnn=0,this.initRTT(),this.initHUD(),void(this._time=0))},toggleDepthVision:function(){var t=this._annVisionGroup.getOrCreateStateSet().getUniform("bDepthVision").getInternalArray()[0];this._annVisionGroup.getOrCreateStateSet().getUniform("bDepthVision").setInt(1===t?0:1)},goNextDPFinView:function(t){if(!(this.getNumDPFs()<2)){var e=this._inviewDPFid;if(!(0>e)){var i=void 0===t?1:t;this.requestTransitionToDPF(this.getDPF(e),i)}}},attachListeners:function(){var t=this;$(function(){$(document).keydown(function(e){if(32==e.keyCode&&t.home(),107==e.keyCode&&void 0!==t._closestDPF){var i=t._closestDPF.getDepthMultiplier();i+=.02,i>1&&(i=1),t._closestDPF.setDepthMultiplier(i)}if(109==e.keyCode&&void 0!==t._closestDPF){var i=t._closestDPF.getDepthMultiplier();i-=.02,0>i&&(i=0),t._closestDPF.setDepthMultiplier(i)}86==e.keyCode&&t.toggleVR(),73==e.keyCode&&void 0!==t._closestDPF&&t._closestDPF.toggleInvertDepth(),75==e.keyCode&&void 0!==t._closestDPF&&t.toggleDepthVision(),81==e.keyCode&&void 0!==t._closestDPF&&t._closestDPF.toggleQuadraticDepth(),80==e.keyCode&&void 0!==t._closestDPF&&t._closestDPF.playOrPauseVideoStreams(),88==e.keyCode,102==e.keyCode&&t.goNextDPFinView(1)})}),t._canvas.addEventListener("mousemove",function(e){var i=t._canvas.getBoundingClientRect(),a=e.clientX-i.left,s=e.clientY-i.top;a=(a/t._canvas.width).toFixed(3),s=(s/t._canvas.height).toFixed(3),t._vrState||(t._annXYquery[0]=a,t._annXYquery[1]=1-s)},!1),Hammer(t._canvas).on("doubletap",function(){t.goNextDPFinView(1)});var e=new DPFupdateCallback(t);t._root.addUpdateCallback(e)},create3Dpointer:function(){var t=this;t._hoverAnnDepth=1,this._pointerModel=osg.createTexturedSphere(.03,20,20);var e=new osg.Material;e.setTransparency(1),e.setDiffuse([1,1,1,1]),this._pointerModel.getOrCreateStateSet().setAttributeAndModes(e),this._pointerModel.getOrCreateStateSet().setTextureAttributeAndModes(0,DPFutils.fallbackWhiteTex),this._pointerModel.getOrCreateStateSet().setRenderingHint("TRANSPARENT_BIN"),this._pointerModel.getOrCreateStateSet().setBinNumber(12),this._pointerModel.getOrCreateStateSet().setAttributeAndModes(new osg.BlendFunc,osg.StateAttribute.ON),t._pointerTrans=new osg.AutoTransform,t._pointerTrans.setPosition([0,0,0]),t._pointerTrans.setAutoRotateToScreen(!0),t._pointerTrans.addChild(t._pointerModel),t._dpfGroup.addChild(t._pointerTrans),t._pointerTrans.setNodeMask(0)},initRTT:function(){if(void 0!==this._viewer.getCamera()){this._aRTT=new osg.Camera,this._aRTT.addChild(this._annVisionGroup),this._aRTT.setName("rttCamera"),this._aRTT.setClearColor(osg.Vec4.create([0,0,0,1])),this._aRTT.setViewMatrix(this._viewer.getCamera().getViewMatrix()),this._aRTT.setProjectionMatrix(this._viewer.getCamera().getProjectionMatrix()),this._aRTT.setRenderOrder(osg.Camera.PRE_RENDER,0),this._aRTT.setReferenceFrame(osg.Transform.ABSOLUTE_RF),this._aRTT.setViewport(new osg.Viewport(0,0,this._aRTTsize[0],this._aRTTsize[1])),this._aRTTttex=new osg.Texture,this._aRTTttex.setTextureSize(this._aRTTsize[0],this._aRTTsize[1]),this._aRTTttex.setInternalFormat(osg.Texture.RGB),this._aRTTttex.setMinFilter("NEAREST"),this._aRTTttex.setMagFilter("NEAREST"),this._aRTT.attachTexture(osg.FrameBufferObject.COLOR_ATTACHMENT0,this._aRTTttex),this._aRTTquad=osg.createTexturedQuadGeometry(5,50,0,this._aRTTsize[0],0,0,0,this._aRTTsize[1],0),this._aRTTquad.getOrCreateStateSet().setTextureAttributeAndModes(0,this._aRTTttex),this._root.addChild(this._aRTT);var t=this;t._aRTTcanvasElem=document.createElement("canvas"),t._aRTTctx=t._aRTTcanvasElem.getContext("2d"),t._aRTTcanvasElem.width=t._aRTTsize[0],t._aRTTcanvasElem.height=t._aRTTsize[1];var e=4*t._aRTTcanvasElem.width,i=(4*t._aRTTcanvasElem.height,e*t._aRTTcanvasElem.height);t._aRTTpixels=new Uint8Array(i);var a=function(i){if(void 0!==t._aRTTcanvasElem){var a=i.getGraphicContext();if(a.checkFramebufferStatus(a.FRAMEBUFFER)===a.FRAMEBUFFER_COMPLETE){a.readPixels(0,0,t._aRTTcanvasElem.width,t._aRTTcanvasElem.height,a.RGBA,a.UNSIGNED_BYTE,t._aRTTpixels);var s=Math.floor(t._aRTTcanvasElem.width*t._annXYquery[0]),o=Math.floor(t._aRTTcanvasElem.height*t._annXYquery[1]),n=t._aRTTpixels[o*e+4*s+0],r=t._aRTTpixels[o*e+4*s+1];if(t._closestDPF){var h=r/255,d=t._closestDPF.getDepthRange();t._hoverAnnDepth=d[1]+h*(d[0]-d[1])-d[0]}var _=Math.floor(n*DPF_ANN_HASH);_!==t._hoverAnn&&(t._hoverAnn=_,t._onChangeAnnotation())}}};t._aRTT.setFinalDrawCallback(a)}},getHoveredAnnotationID:function(){return this._hoverAnn},_onChangeAnnotation:function(){if(this._stdVisionGroup.getOrCreateStateSet().getUniform("annotationHash").setInt(this._hoverAnn),this._hoverAnn>0){void 0!==this.onHoverAnnotation&&this.onHoverAnnotation();for(var t=0;t<this._closestDPF._annotationList.length;t++){var e=this._closestDPF._annotationList[t];e.hashID===this._hoverAnn&&void 0!==e.onHover&&e.onHover()}this._vrState||(this._canvas.style.cursor="pointer")}else this._vrState||(this._canvas.style.cursor="auto"),void 0!==this.onLeaveAnnotation&&this.onLeaveAnnotation()},initHUD:function(){void 0!==this._canvas&&(this._HUD=new osg.Camera,osg.Matrix.makeOrtho(0,this._canvas.width,0,this._canvas.height,-5,5,this._HUD.getProjectionMatrix()),osg.Matrix.makeTranslate(25,25,0,this._HUD.getViewMatrix()),this._HUD.setRenderOrder(osg.Camera.NESTED_RENDER,0),this._HUD.setReferenceFrame(osg.Transform.ABSOLUTE_RF),void 0!==this._aRTTquad&&this._HUD.addChild(this._aRTTquad),this._root.addChild(this._HUD),this.toggleDebugCam(!1))},toggleDebugCam:function(t){this._aRTTquad.setNodeMask(t?15:0)},loadShadersFromPath:function(t,e){var i=this;i._shadersPath=t,void 0!==e&&(i._useUnifiedLayout=e),$.get(t+"/main.vert",function(e){i._useUnifiedLayout&&(e="#define DPF_USE_COMBO 1\n"+e),e+="\n",$.get(t+"/main.frag",function(t){i._useUnifiedLayout&&(t="#define DPF_USE_COMBO 1\n"+t),t+="\n";var a=new osg.Program(new osg.Shader("VERTEX_SHADER",e),new osg.Shader("FRAGMENT_SHADER",t));i._glslProgram=a,i.onGLSLprogramLoaded()},"text")},"text")},onGLSLprogramLoaded:function(){if(void 0!==this._glslProgram){for(var t=0;t<this._dpfList.length;t++)this._dpfList[t].setGLSLprogram(this._glslProgram),this._useUnifiedLayout&&(this._dpfList[t]._useUnifiedLayout=!0);console.log("GLSL Program Loaded")}},setupFallbacks:function(){this._stdVisionGroup.getOrCreateStateSet().setTextureAttributeAndModes(DPF_PANO_UNIT,DPFutils.fallbackWhiteTex),this._stdVisionGroup.getOrCreateStateSet().setTextureAttributeAndModes(DPF_DEPTH_UNIT,DPFutils.fallbackBlackTex),this._stdVisionGroup.getOrCreateStateSet().setTextureAttributeAndModes(DPF_ANN_UNIT,DPFutils.fallbackBlackTex),this._annVisionGroup.getOrCreateStateSet().setTextureAttributeAndModes(DPF_PANO_UNIT,DPFutils.fallbackBlackTex),this._annVisionGroup.getOrCreateStateSet().setTextureAttributeAndModes(DPF_DEPTH_UNIT,DPFutils.fallbackBlackTex),this._annVisionGroup.getOrCreateStateSet().setTextureAttributeAndModes(DPF_ANN_UNIT,DPFutils.fallbackBlackTex),console.log("Fallbacks set")},home:function(){if(0==this._dpfList.length||void 0===this._dpfList[0])return this._manip.setEyePosition([0,0,0]),this._manip.setTarget([1,0,0]),void this._manip.setNode(this._dpfGroup);var t;t=void 0===this._closestDPF?this._dpfList[0].getPosition():this._closestDPF.getPosition(),this._manip.setEyePosition(t),this._manip.setNode(this._dpfGroup)},goExternalView:function(){if(void 0!==this._closestDPF){var t=this._closestDPF.getPosition(),e=this._closestDPF.getDepthRange()[1],i=osg.Vec3.create();i[0]=t[0]+1*e,i[1]=t[1]+1*e,i[2]=t[2]+.5*e,this._manip.setEyePosition(i),this._manip.setTarget(t)}},setFOV:function(t){if(this._fov=t,void 0!==this._viewer){var e=this._viewer.getCamera();if(void 0!==e){var i={};osg.Matrix.getPerspective(e.getProjectionMatrix(),i),osg.Matrix.makePerspective(t,i.aspectRatio,i.zNear,i.zFar,e.getProjectionMatrix())}}},getFOV:function(){return this._fov},addDPF:function(t){this._dpfList.push(t),this._stdVisionGroup.addChild(t.getTransNode()),this._annVisionGroup.addChild(t.getTransNode()),void 0!==this._glslProgram&&t.setGLSLprogram(this._glslProgram),console.log("Added new DPF")},getDPF:function(t){return this._dpfList[t]},getDPFbyName:function(t){for(var e=0;e<this._dpfList.length;e++)if(this._dpfList[e]._uniqueName===t)return this._dpfList[e];return void 0},getNumDPFs:function(){return this._dpfList.length},useUnifiedLayout:function(t){this._useUnifiedLayout=t},isUsingUnifiedLayout:function(){return this._useUnifiedLayout},requestTransitionToLocation:function(t,e){this._tMoveReq>=0||(this._tMoveReq=this._time,this._tMoveDur=e,this._reqTo=t,this._reqFrom=this._eyePos)},duringTransition:function(){return _tMoveReq>=0},requestTransitionToDPF:function(t,e){void 0!==this._manip&&void 0!==t&&(void 0===e?this._manip.setEyePosition(t.getPosition()):this.requestTransitionToLocation(t.getPosition(),e))},requestTransitionToDPFbyIndex:function(t,e){var i=this._dpfList[t];void 0!==i&&this.requestTransitionToDPF(i,e)},requestTransitionToDPFbyName:function(t,e){var i=this.getDPFbyName(t);void 0!==i&&this.requestTransitionToDPF(i,e)},parseXML:function(t,e){var i=t.substring(0,t.lastIndexOf("/")+1),a=".jpg",s="-d.png",o="-a.png",n=this;console.log("Loading XML: "+t+"..."),$.get(t,function(t){i+=$(t).find("basepath").text();var r=$(t).find("postfix");void 0!==r&&(void 0!==r.attr("color")&&(a=r.attr("color")),void 0!==r.attr("depth")&&(s=r.attr("depth")),void 0!==r.attr("annotation")&&(o=r.attr("annotation"))),$(t).find("DPF").each(function(){var t=new DPF;n.addDPF(t),console.log("Parsing DPF...");var e=$(this).find("position");void 0!==e.attr("x")&&void 0!==e.attr("y")&&void 0!==e.attr("z")&&t.setPosition([parseFloat(e.attr("x")),parseFloat(e.attr("y")),parseFloat(e.attr("z"))]);var r=$(this).find("orientation");void 0!==r.attr("x")&&void 0!==r.attr("y")&&void 0!==r.attr("z")&&t.setOrientationFromEulerVector([parseFloat(r.attr("x")),parseFloat(r.attr("y")),parseFloat(r.attr("z"))]);var h=$(this).find("name");if(void 0!==h){var d=h.text();t.setUniqueName(d),t.setPanoPath(i+d+a,i+"lo_"+d+a),t.setDepthPath(i+d+s),t.setAnnotationPath(i+d+o)}var _=$(this).find("depthrange");void 0!==_&&void 0!==_.attr("min")&&void 0!==_.attr("max")&&t.setDepthRange(parseFloat(_.attr("min")),parseFloat(_.attr("max")))});for(var h=0;h<n._dpfList.length;h++)n.getDPF(h).requestPano(),n._useUnifiedLayout||(n.getDPF(h).requestDepth(),n.getDPF(h).requestAnnotation());n.home(),void 0!==e&&e()}).fail(function(){console.log("ERROR Loading XML")})},getVRstate:function(){return this._vrState},toggleVR:function(){var t=this._viewer;if(t.setPresentVR(!this._vrState),this._vrState)t._eventProxy.WebVR.setEnable(!1),t._eventProxy.DeviceOrientation.setEnable(!1),this._root.removeChild(this._vrNode),this._root.addChild(this._dpfGroup),this._pointerTrans.setNodeMask(0);else{if(this._root.removeChild(this._dpfGroup),!this._vrNode)if(navigator.getVRDisplays){t.getEventProxy().WebVR.setEnable(!0);var e=t._eventProxy.WebVR.getHmd();this._vrNode=osgUtil.WebVR.createScene(t,this._dpfGroup,e)}else t.getEventProxy().DeviceOrientation.setEnable(!0),this._vrNode=osgUtil.WebVRCustom.createScene(t,this._dpfGroup,{isCardboard:!0,vResolution:this._canvas.height,hResolution:this._canvas.width});this._root.addChild(this._vrNode),this._annXYquery[0]=.5,this._annXYquery[1]=.5,this._pointerTrans.setNodeMask(15),this.home()}this._vrState=!this._vrState}};