/*


  DPF javascript implementation

  @author Bruno Fanini
 VHLab, CNR ITABC

 When using this JS library, add also reference to EG publication:

 @inproceedings {gch.20161380,
  booktitle = {Eurographics Workshop on Graphics and Cultural Heritage},
  editor = {Chiara Eva Catalano and Livio De Luca},
  title = {{A Framework for Compact and Improved Panoramic VR Dissemination}},
  author = {Fanini, Bruno and D'Annibale, Enzo},
  year = {2016},
  publisher = {The Eurographics Association},
  ISSN = {2312-6124},
  ISBN = {978-3-03868-011-6},
  DOI = {10.2312/gch.20161380}
 }

==================================================================================*/
var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.findInternal=function(a,b,c){a instanceof String&&(a=String(a));for(var d=a.length,e=0;e<d;e++){var f=a[e];if(b.call(c,f,e,a))return{i:e,v:f}}return{i:-1,v:void 0}};$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(a,b,c){a!=Array.prototype&&a!=Object.prototype&&(a[b]=c.value)};
$jscomp.getGlobal=function(a){return"undefined"!=typeof window&&window===a?a:"undefined"!=typeof global&&null!=global?global:a};$jscomp.global=$jscomp.getGlobal(this);$jscomp.polyfill=function(a,b,c,d){if(b){c=$jscomp.global;a=a.split(".");for(d=0;d<a.length-1;d++){var e=a[d];e in c||(c[e]={});c=c[e]}a=a[a.length-1];d=c[a];b=b(d);b!=d&&null!=b&&$jscomp.defineProperty(c,a,{configurable:!0,writable:!0,value:b})}};
$jscomp.polyfill("Array.prototype.find",function(a){return a?a:function(a,c){return $jscomp.findInternal(this,a,c).v}},"es6","es3");
var OSG=window.OSG,osg=OSG.osg,osgDB=OSG.osgDB,osgViewer=OSG.osgViewer,osgUtil=OSG.osgUtil,osgGA=OSG.osgGA,osgText=OSG.osgText,DPF_RAD_SCALE=100,DPF_ANN_HASH=.3,DPF_PANO_UNIT=0,DPF_DEPTH_UNIT=1,DPF_ANN_UNIT=2,DPF_RAD2DEG=180/Math.PI,DPF_DEG2RAD=Math.PI/180,DPF_X_AXIS=[1,0,0],DPF_Y_AXIS=[0,1,0],DPF_Z_AXIS=[0,0,1],DPFutils={videoExts:"mp4 avi ogg ogv webm mpd".split(" "),getFileExtension:function(a){return a.substr(a.lastIndexOf(".")+1).toLowerCase()},isURLvideo:function(a){a=this.getFileExtension(a);
for(var b=0;b<DPFutils.videoExts.length;b++)if(a==DPFutils.videoExts[b].toLowerCase())return!0;return!1}};DPFutils.bkIM=new window.Image;DPFutils.bkIM.src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNg+A8AAQIBANEay48AAAAASUVORK5CYII\x3d";DPFutils.wIM=new window.Image;DPFutils.wIM.src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAC0lEQVQIW2P8DwQACgAD/il4QJ8AAAAASUVORK5CYII\x3d";DPFutils.fallbackBlackTex=new osg.Texture;DPFutils.fallbackBlackTex.setImage(DPFutils.bkIM);
DPFutils.fallbackBlackTex.setMinFilter(osg.Texture.LINEAR);DPFutils.fallbackBlackTex.setMagFilter(osg.Texture.LINEAR);DPFutils.fallbackBlackTex.setWrapS(osg.Texture.REPEAT);DPFutils.fallbackBlackTex.setWrapT(osg.Texture.REPEAT);DPFutils.fallbackWhiteTex=new osg.Texture;DPFutils.fallbackWhiteTex.setImage(DPFutils.wIM);DPFutils.fallbackWhiteTex.setMinFilter(osg.Texture.LINEAR);DPFutils.fallbackWhiteTex.setMagFilter(osg.Texture.LINEAR);DPFutils.fallbackWhiteTex.setWrapS(osg.Texture.REPEAT);DPFutils.fallbackWhiteTex.setWrapT(osg.Texture.REPEAT);
DPFutils.detectMobileDevice=function(){return/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|ipad|iris|kindle|Android|Silk|lge |maemo|midp|mmp|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows (ce|phone)|xda|xiino/i.test(navigator.userAgent)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(navigator.userAgent.substr(0,
4))?!0:!1};DPFutils.lerp=function(a,b,c){return a+(b-a)*c};DPFutils._useMobile=DPFutils.detectMobileDevice();
var DPF=function(a,b,c){this._uniqueName="";this._position=[0,0,0];this._mOrient=void 0;this._vOrient=[0,0,0];this._mainTrans=new osg.MatrixTransform;this._glslProgram=void 0;this.initUniforms();this._useUnifiedLayout=!1;this._annPath=this._depthPath=this._panoPathLow=this._panoPath=void 0;this._isAnnVid=this._isDepthVid=this._isPanoVid=!1;this._annVidElem=this._depthVidElem=this._panoVidElem=void 0;this._depthRange={min:0,max:1/DPF_RAD_SCALE};this.setDepthRange(20,20);this._maxBoundSphere=this._baseGeom=
void 0;this._baseGeomResolution=DPFutils._useMobile?40:128;this.realizeBaseSphere();this._bLoading=[!1,!1,!1];this._bLoaded=[!1,!1,!1];this._annotationList=[];void 0!==a&&this.requestPano(a);void 0!==b&&this.requestDepth(b);void 0!==c&&this.requestSemantic(c)};
DPF.prototype={setUniqueName:function(a){this._uniqueName=a},getUniqueName:function(){return this._uniqueName},setPanoPath:function(a,b){this._panoPath=a;void 0!==b&&(this._panoPathLow=b);DPFutils.isURLvideo(a)&&(this._isPanoVid=!0,console.log("Detected pano video stream"))},getPanoPath:function(){return this._panoPath},setDepthPath:function(a){this._depthPath=a;DPFutils.isURLvideo(a)&&(this._isDepthVid=!0,console.log("Detected depth video stream"))},getDepthPath:function(){return this._depthPath},
setSemanticPath:function(a){this._annPath=a},getSemanticPath:function(){return this._annPath},isLoading:function(){return this._bLoading[0]||this._bLoading[1]||this._bLoading[2]},setPosition:function(a){this._position=a;this.updateMatrixTransform()},getPosition:function(){return this._position},setOrientationFromQuaternion:function(a){this._orientation=a;this.updateMatrixTransform()},setOrientationFromEulerVector:function(a){this._mOrient=osg.mat4.create();var b=osg.mat4.create();osg.mat4.rotate(b,
b,a[0],DPF_X_AXIS);var c=osg.mat4.create();osg.mat4.rotate(c,c,a[1],DPF_Y_AXIS);var d=osg.mat4.create();osg.mat4.rotate(d,d,a[2],DPF_Z_AXIS);this._mOrient=b;osg.mat4.multiply(this._mOrient,this._mOrient,c);osg.mat4.multiply(this._mOrient,this._mOrient,d);this._vOrient[0]=a[0];this._vOrient[1]=a[1];this._vOrient[2]=a[2];this.updateMatrixTransform()},getOrientation:function(){return this._vOrient},getTransNode:function(){return this._mainTrans},setDepthRange:function(a,b){this._depthRange.min=a/DPF_RAD_SCALE;
this._depthRange.max=b/DPF_RAD_SCALE;this._mainTrans.getOrCreateStateSet().getUniform("minRad").setFloat(this._depthRange.min);this._mainTrans.getOrCreateStateSet().getUniform("maxRad").setFloat(this._depthRange.max);this._dErr=((b-a)/256).toFixed(3);console.log("- DPF max depth error: "+this._dErr)},getDepthRange:function(){return[this._depthRange.min*DPF_RAD_SCALE,this._depthRange.max*DPF_RAD_SCALE]},setDepthMultiplier:function(a){this._mainTrans.getOrCreateStateSet().getUniform("radMult").setFloat(a)},
getDepthMultiplier:function(){return this._mainTrans.getOrCreateStateSet().getUniform("radMult").getInternalArray()[0]},getDepthErrorAtDistance:function(a){var b=this._depthRange.min*DPF_RAD_SCALE,c=this._depthRange.max*DPF_RAD_SCALE;if(a<=b)return 0;if(a>c)return this._dErr;a=(a-b)/(c-b);b=this._dErr;b=this.getQuadraticDepth()?b*a*a:b*a;return b.toFixed(6)},setVisibility:function(a){this._mainTrans.getOrCreateStateSet().getUniform("visibility").setFloat(a)},getVisibility:function(){return this._mainTrans.getOrCreateStateSet().getUniform("visibility").getInternalArray()[0]},
setDiscardFactor:function(a){this._mainTrans.getOrCreateStateSet().getUniform("slopeDiscard").setFloat(a)},getDiscardFactor:function(){return this._mainTrans.getOrCreateStateSet().getUniform("slopeDiscard").getInternalArray()[0]},setQuadraticDepth:function(a){this._mainTrans.getOrCreateStateSet().getUniform("bQuadratic").setInt(a)},toggleQuadraticDepth:function(){1===this._mainTrans.getOrCreateStateSet().getUniform("bQuadratic").getInternalArray()[0]?this._mainTrans.getOrCreateStateSet().getUniform("bQuadratic").setInt(0):
this._mainTrans.getOrCreateStateSet().getUniform("bQuadratic").setInt(1)},getQuadraticDepth:function(){return this._mainTrans.getOrCreateStateSet().getUniform("bQuadratic").getInternalArray()[0]},toggleInvertDepth:function(){1===this._mainTrans.getOrCreateStateSet().getUniform("bInvertDM").getInternalArray()[0]?this._mainTrans.getOrCreateStateSet().getUniform("bInvertDM").setInt(0):this._mainTrans.getOrCreateStateSet().getUniform("bInvertDM").setInt(1)},getInvertDepth:function(){return this._mainTrans.getOrCreateStateSet().getUniform("bInvertDM").getInternalArray()[0]},
setGLSLprogram:function(a){void 0!==a&&(this._glslProgram=a,this._mainTrans.getOrCreateStateSet().setAttributeAndModes(a))},getGLSLprogram:function(){return this._glslProgram},initUniforms:function(){var a=this._mainTrans.getOrCreateStateSet();a.addUniform(osg.Uniform.createFloat1(0,"minRad"));a.addUniform(osg.Uniform.createFloat1(1/DPF_RAD_SCALE,"maxRad"));a.addUniform(osg.Uniform.createFloat1(1,"radMult"));a.addUniform(osg.Uniform.createFloat1(1,"visibility"));a.addUniform(osg.Uniform.createFloat1(0,
"slopeDiscard"));a.addUniform(osg.Uniform.createInt1(1,"bQuadratic"));a.addUniform(osg.Uniform.createInt1(0,"bInvertDM"));a.addUniform(osg.Uniform.createInt1(1,"bActive"))},updateMatrixTransform:function(){var a=osg.mat4.create();osg.mat4.translate(a,a,this._position);void 0!==this._mOrient&&osg.mat4.multiply(a,a,this._mOrient);var b=osg.mat4.create();osg.mat4.fromScaling(b,[DPF_RAD_SCALE,DPF_RAD_SCALE,DPF_RAD_SCALE]);osg.mat4.multiply(a,a,b);console.log("Updated DPF Position: "+this._position);this._mainTrans.setMatrix(a)},
realizeBaseSphere:function(){this._mainTrans.setCullingActive(!1);this.updateMatrixTransform();this._baseGeom=osg.createTexturedSphere(1,this._baseGeomResolution,this._baseGeomResolution);this._baseGeom.setCullingActive(!1);this._baseGeom.getOrCreateStateSet().setAttributeAndModes(new osg.CullFace("DISABLE"));var a=osg.mat4.create();osg.mat4.rotate(a,a,-Math.PI/2,DPF_X_AXIS);this._baseGeomT=new osg.MatrixTransform;this._baseGeomT.setMatrix(a);this._baseGeomT.setCullingActive(!1);this._baseGeomT.addChild(this._baseGeom);
this._mainTrans.addChild(this._baseGeomT)},requestPano:function(a){var b=this;b._bLoading[0]=!0;void 0!==a&&b.setPanoPath(a);if(void 0!==b._panoPath)if(b._isPanoVid){b._panoVidElem=document.createElement("video");b._panoVidElem.style.display="none";var c=new osg.ImageStream(b._panoVidElem);b._panoVidElem.preload="auto";b._panoVidElem.loop=!0;b._panoVidElem.crossOrigin="anonymous";b._panoVidElem.src=b._panoPath;c.whenReady().then(function(a){var d=new osg.Texture;d.setImage(c);d.setMinFilter(osg.Texture.LINEAR);
d.setMagFilter(osg.Texture.LINEAR);d.setWrapS(osg.Texture.REPEAT);d.setWrapT(osg.Texture.CLAMP_TO_EDGE);d.setFlipY(!1);b._mainTrans.getOrCreateStateSet().setTextureAttributeAndModes(DPF_PANO_UNIT,d);console.log("Videopano "+b._panoPath+" loaded.");b._bLoading[0]=!1;b._bLoaded[0]=!0;a.play()}.bind(b))}else{var d=new osg.Texture;(function(a,c){osgDB.readImageURL(a).then(function(e){d.setImage(e);d.setMinFilter(osg.Texture.LINEAR_MIPMAP_LINEAR);d.setMagFilter(osg.Texture.LINEAR);d.setWrapS(osg.Texture.REPEAT);
d.setWrapT(osg.Texture.CLAMP_TO_EDGE);d.setFlipY(!1);b._mainTrans.getOrCreateStateSet().setTextureAttributeAndModes(DPF_PANO_UNIT,d);console.log("Pano texture "+a+" loaded.");b._bLoading[0]=!1;b._bLoaded[0]=!0;c()})})(b._panoPath,function(){b._bLoading[0]=!1;b._bLoaded[0]=!0})}},requestColor:function(a){return this.requestPano(a)},requestDepth:function(a){if(!this._useUnifiedLayout){var b=this;b._bLoading[1]=!0;void 0!==a&&b.setDepthPath(a);if(void 0!==b._depthPath)if(b._isDepthVid){b._depthVidElem=
document.createElement("video");b._depthVidElem.style.display="none";var c=new osg.ImageStream(b._depthVidElem);b._depthVidElem.preload="auto";b._depthVidElem.loop=!0;b._depthVidElem.crossOrigin="anonymous";b._depthVidElem.src=b._depthPath;c.whenReady().then(function(a){var d=new osg.Texture;d.setImage(c);d.setMinFilter(osg.Texture.LINEAR);d.setMagFilter(osg.Texture.LINEAR);d.setWrapS(osg.Texture.REPEAT);d.setWrapT(osg.Texture.CLAMP_TO_EDGE);d.setFlipY(!1);b._mainTrans.getOrCreateStateSet().setTextureAttributeAndModes(DPF_DEPTH_UNIT,
d);console.log("VideoDepth "+b._depthPath+" loaded.");b._bLoading[1]=!1;b._bLoaded[1]=!0;a.play()}.bind(b))}else osgDB.readImageURL(b._depthPath).then(function(a){var c=new osg.Texture;c.setImage(a);c.setMinFilter(osg.Texture.LINEAR_MIPMAP_LINEAR);c.setMagFilter(osg.Texture.LINEAR);c.setWrapS(osg.Texture.REPEAT);c.setWrapT(osg.Texture.CLAMP_TO_EDGE);c.setFlipY(!1);b._mainTrans.getOrCreateStateSet().setTextureAttributeAndModes(DPF_DEPTH_UNIT,c);console.log("Depth texture "+b._depthPath+" loaded.");
b._bLoading[1]=!1;b._bLoaded[1]=!0})}},requestSemantic:function(a){if(!this._useUnifiedLayout){var b=this;b._bLoading[2]=!0;void 0!==a&&b.setSemanticPath(a);void 0!==b._annPath&&osgDB.readImageURL(b._annPath).then(function(a){var c=new osg.Texture,e=a.getImage();e.setAttribute("data-pagespeed-no-transform","true");e.setAttribute("pagespeed-no-transform","true");c.setImage(a);c.setMinFilter("NEAREST");c.setMagFilter("NEAREST");c.setWrapS(osg.Texture.REPEAT);c.setWrapT(osg.Texture.CLAMP_TO_EDGE);c.setFlipY(!1);
b._mainTrans.getOrCreateStateSet().setTextureAttributeAndModes(DPF_ANN_UNIT,c);console.log("Annotation texture "+b._annPath+" loaded.");b._bLoading[2]=!1;b._bLoaded[2]=!0})}},playVideoStreams:function(){void 0!==this._panoVidElem&&this._panoVidElem.play();void 0!==this._depthVidElem&&this._depthVidElem.play();void 0!==this._annVidElem&&this._annVidElem.play();this._isVideoStreamOnPlay=!0},pauseVideoStreams:function(){void 0!==this._panoVidElem&&this._panoVidElem.pause();void 0!==this._depthVidElem&&
this._depthVidElem.pause();void 0!==this._annVidElem&&this._annVidElem.pause();this._isVideoStreamOnPlay=!1},isPlayingVideoStreams:function(){return this._isVideoStreamOnPlay},playOrPauseVideoStreams:function(){this._isVideoStreamOnPlay?this.pauseVideoStreams():this.playVideoStreams()},syncVideoStreams:function(){if(void 0!==this._panoVidElem){var a=this._panoVidElem.currentTime;void 0!==this._depthVidElem&&(this._depthVidElem.currentTime=a);void 0!==this._annVidElem&&(this._annVidElem.currentTime=
a)}},registerAnnotation:function(a,b,c){var d=new DPFannotation(this,a);void 0!==b&&(d.onHover=b);void 0!==c&&(d.onSelect=c);this._annotationList[a]=d},onHoverAnnotation:function(a,b){void 0===this._annotationList[a]&&(this._annotationList[a]=new DPFannotation(this,a));this._annotationList[a].onHover=b},onSelectAnnotation:function(a,b){void 0===this._annotationList[a]&&(this._annotationList[a]=new DPFannotation(this,a));this._annotationList[a].onSelect=b}};
var DPFannotation=function(a,b){var c=this;c.dpf=a;c.hashID=b;c.onHover=function(){console.log("Hovering annotation #"+c.hashID)};c.onSelect=function(){console.log("Selected annotation #"+c.hashID)}},DPFupdateCallback=function(a){this._dpfh=a;this._tReqNorm=0;this._vD=osg.vec3.create();this._vE=osg.vec3.create();this._focP=osg.vec3.create();this._distView=this._distTarg=Number.MAX_VALUE;this._bView=!1};
DPFupdateCallback.prototype={update:function(a,b){a=this._dpfh;a._time=b.getFrameStamp().getSimulationTime();if(0>a._time-a._time)return!0;a._ssGlobal.getUniform("time").setFloat(a._time);a._ssGlobal.getUniform("DOF").setFloat2([a._DOFweight,a._hoverAnnDepth]);if(0==a._dpfList.length)return!0;0<a._tDIMreq&&a._handleDIM();a._manip.getEyePosition(a._eyePos);a._manip.getTarget(a._targPos);a._targD2=1E3*osg.vec3.squaredDistance(a._targPos,a._lastTargPos);a._posD2=1E3*osg.vec3.squaredDistance(a._eyePos,
a._lastEyePos);.002<a._targD2||.01<a._posD2?a._bRTTcanRead=!1:a._bRTTcanRead=!0;a._lastTargPos[0]=a._targPos[0];a._lastTargPos[1]=a._targPos[1];a._lastTargPos[2]=a._targPos[2];a._lastEyePos[0]=a._eyePos[0];a._lastEyePos[1]=a._eyePos[1];a._lastEyePos[2]=a._eyePos[2];osg.vec3.sub(a._direction,a._targPos,a._eyePos);osg.vec3.normalize(a._direction,a._direction);osg.vec3.add(a._targPos,a._eyePos,a._direction);a._ssGlobal.getUniform("uWorldEyePos").setFloat3(a._eyePos);a._ssGlobal.getUniform("uViewDir").setFloat3(a._direction);
a._update3Dpointer();this._distView=this._distTarg=Number.MAX_VALUE;this._bView=!1;b=a._dpfList.length;for(var c=0;c<b;c++){var d=a._dpfList[c],e=d.getPosition();d.setVisibility(0);osg.vec3.sub(this._vE,a._eyePos,e);var f=osg.vec3.squaredDistance(a._eyePos,e);1<f&&(osg.vec3.normalize(this._vE,this._vE),-.8>osg.vec3.dot(a._direction,this._vE)&&f<this._distView&&(a._inviewDPFid=c,this._distView=f));osg.vec3.lerp(this._focP,a._eyePos,a._pointerTrans.getPosition(),0);osg.vec3.sub(this._vD,this._focP,
e);e=osg.vec3.squaredDistance(this._focP,e);e<this._distTarg&&(this._distTarg=e,a._activeDPF=d,a._activeDPFid=c)}a._activeDPF.setVisibility(1);a._preloadDPF(a._activeDPF);0<=a._inviewDPFid&&1<b&&a._updateInsightDPF();if(0<=a._tMoveReq)if(this._tReqNorm=(a._time-a._tMoveReq)/a._tMoveDur,1<=this._tReqNorm){if(a._tMoveReq=-1,a._eyePos[0]=a._reqTo[0],a._eyePos[1]=a._reqTo[1],a._eyePos[2]=a._reqTo[2],a._targPos[0]=a._eyePos[0]+a._direction[0],a._targPos[1]=a._eyePos[1]+a._direction[1],a._targPos[2]=a._eyePos[2]+
a._direction[2],a._inviewDPFid=-1,a._insightTrans.setNodeMask(0),a.onTransitionEnded)a.onTransitionEnded()}else this._tReqNorm=(1-Math.cos(this._tReqNorm*Math.PI))/2,osg.vec3.lerp(a._eyePos,a._reqFrom,a._reqTo,this._tReqNorm);a._manip.setEyePosition(a._eyePos);a._handleGamepads();if(void 0!==a.onTick)a.onTick();return!0}};
var DPFhandler=function(a,b){void 0===a?console.log("Canvas not valid"):(this._canvas=a,this._useMobile=DPFutils._useMobile,this._useDeviceOrientation=!1,this._viewer=void 0===b?void 0:b,this._dpfList=[],this._root=new osg.Node,this._root.setName("root"),this._dpfGroup=new osg.Node,this._stdVisionGroup=new osg.Node,this._annVisionGroup=new osg.Node,this._stdVisionGroup.getOrCreateStateSet().setAttributeAndModes(new osg.CullFace(osg.CullFace.FRONT),osg.StateAttribute.ON|osg.StateAttribute.OVERRIDE),
this._stdVisionGroup.getOrCreateStateSet().setAttributeAndModes(new osg.Depth(osg.Depth.ENABLE),osg.StateAttribute.ON|osg.StateAttribute.OVERRIDE),this._stdVisionGroup.getOrCreateStateSet().setAttributeAndModes(new osg.BlendFunc,osg.StateAttribute.ON|osg.StateAttribute.OVERRIDE),this._stdVisionGroup.getOrCreateStateSet().setRenderingHint("TRANSPARENT_BIN"),this._annVisionGroup.getOrCreateStateSet().setAttributeAndModes(new osg.Depth(osg.Depth.ENABLE),osg.StateAttribute.ON|osg.StateAttribute.OVERRIDE),
this._annVisionGroup.getOrCreateStateSet().setAttributeAndModes(new osg.CullFace(osg.CullFace.FRONT),osg.StateAttribute.ON|osg.StateAttribute.OVERRIDE),this._annVisionGroup.getOrCreateStateSet().setAttributeAndModes(new osg.BlendFunc,osg.StateAttribute.OFF|osg.StateAttribute.OVERRIDE),this._annVisionGroup.getOrCreateStateSet().setRenderingHint("OPAQUE_BIN"),this.setupFallbacks(),this._dpfGroup.addChild(this._stdVisionGroup),this._initGlobalUniforms(),this.resetDIM(),this._annXYquery=[.5,.5],this._create3Dpointer(),
this._aEnabled=this._bRTTcanRead=!0,this.onTransitionEnded=this.onTransitionRequest=this.onSelectAnnotation=this.onLeaveAnnotation=this.onHoverAnnotation=void 0,this._createInsightPointer(),this.onTick=void 0,this._root.addChild(this._dpfGroup),this._glslProgram=this._shadersPath=void 0,this._manip=new osgGA.FirstPersonManipulator,this._manip.setNode(this._dpfGroup),this._manip.setEyePosition(osg.vec3.fromValues(0,0,0)),this._manip.setTarget(osg.vec3.fromValues(0,1,0)),this._manip._stepFactor=.5,
this._manip.setStepFactor(.5),this._manip.computeHomePosition=function(){},this._eyePos=osg.vec3.fromValues(0,0,0),this._targPos=osg.vec3.fromValues(0,1,0),this._direction=osg.vec3.fromValues(0,1,0),this._fov=60,this._lastTargPos=osg.vec3.fromValues(0,0,0),this._lastEyePos=osg.vec3.fromValues(0,0,0),this._reqFrom=osg.vec3.create(),this._reqTo=osg.vec3.create(),this._tMoveReq=-1,this._tMoveDur=3,this._activeDPF=void 0,this._inviewDPFid=this._activeDPFid=-1,this._vrState=this._bDepthVision=!1,this._vrNode=
void 0)};
DPFhandler.prototype={_initGlobalUniforms:function(){this._ssGlobal=this._dpfGroup.getOrCreateStateSet();this._ssVis=this._stdVisionGroup.getOrCreateStateSet();this._ssAnn=this._annVisionGroup.getOrCreateStateSet();this._DIMweight=0;this._DIMcolor=osg.vec4.fromValues(0,0,0,this._DIMweight);this._annActiveColor=osg.vec4.fromValues(.2,1,.2,1);this._tDIMdur=1;this._DOFweight=0;this._vPointerDir=osg.vec3.create();this._useUnifiedLayout=!1;this._ssGlobal.addUniform(osg.Uniform.createInt1(DPF_PANO_UNIT,"panoTex"));
this._ssGlobal.addUniform(osg.Uniform.createInt1(DPF_DEPTH_UNIT,"depthTex"));this._ssGlobal.addUniform(osg.Uniform.createInt1(DPF_ANN_UNIT,"annTex"));this._ssGlobal.addUniform(osg.Uniform.createFloat1(0,"time"));this._ssGlobal.addUniform(osg.Uniform.createInt1(0,"annotationHash"));this._ssGlobal.addUniform(osg.Uniform.createInt1(0,"bDepthVision"));this._ssGlobal.addUniform(osg.Uniform.createFloat4(this._DIMcolor,"dimColor"));this._ssGlobal.addUniform(osg.Uniform.createFloat4(this._annActiveColor,
"annActiveColor"));this._ssGlobal.addUniform(osg.Uniform.createFloat2([this._DOFweight,0],"DOF"));this._ssGlobal.addUniform(osg.Uniform.createFloat3(osg.vec3.create(),"uViewDir"));this._ssGlobal.addUniform(osg.Uniform.createFloat3(osg.vec3.create(),"uWorldEyePos"));this._ssVis.addUniform(osg.Uniform.createInt1(0,"bAnnotationVision"));this._ssAnn.addUniform(osg.Uniform.createInt1(1,"bAnnotationVision"))},run:function(){void 0===this._canvas?console.log("ERROR: you must provide a canvas element"):(void 0===
this._viewer&&(this._viewer=new osgViewer.Viewer(this._canvas,{antialias:!0,enableFrustumCulling:!1,alpha:!0})),this._viewer.init(),this._viewer.setLightingMode(osgViewer.View.LightingMode.NO_LIGHT),this._viewer.setSceneData(this._root),this._viewer.setManipulator(this._manip),this._manip.setNode(this._dpfGroup),this.setFOV(this._fov),this._viewer.run(),this._NFR=.0003,this._viewer.getCamera().setNearFarRatio(this._NFR),this._aRTTsize=[256,256],this._hoverAnn=0,this.initRTT(),this.initHUD(),this._time=
0,this._attachListeners())},_handlePositionalGamepad:function(a){},_handleGamepads:function(){this.gamepads=navigator.getGamepads();for(var a=0;a<this.gamepads.length;++a){var b=this.gamepads[a];if(b)for(var c=0;c<b.buttons.length;++c)b.buttons[c].pressed&&(3===c?myExplorer.home():myExplorer.goNextDPFinView(1))}},useDeviceOrientation:function(a){void 0!==this._viewer&&(this._useDeviceOrientation=a,this._viewer.getEventProxy().DeviceOrientation.setEnable(a),a&&(this._annXYquery=[.5,.5]))},toggleDepthVision:function(){1===
this._ssGlobal.getUniform("bDepthVision").getInternalArray()[0]?(this._ssGlobal.getUniform("bDepthVision").setInt(0),this._bDepthVision=!1):(this._ssGlobal.getUniform("bDepthVision").setInt(1),this._bDepthVision=!0)},_handleDIM:function(){this._tDIM=(this._time-this._tDIMreq)/this._tDIMdur;1<=this._tDIM?(this._tDIMreq=-1,this._DIMcolor[3]=this._DIMweight):this._DIMcolor[3]=this._DIMweight*this._tDIM;this._ssGlobal.getUniform("dimColor").setFloat4(this._DIMcolor)},requestDIManimation:function(){0>=
this._DIMweight||(this._tDIMreq=this._time)},resetDIM:function(){this._tDIMreq=-1;this._DIMcolor[3]=0;this._ssGlobal.getUniform("dimColor").setFloat4(this._DIMcolor)},setDIMcolor:function(a){this._DIMcolor[0]=a[0];this._DIMcolor[1]=a[1];this._DIMcolor[2]=a[2]},setAnnotationActiveColor:function(a){this._annActiveColor[0]=a[0];this._annActiveColor[1]=a[1];this._annActiveColor[2]=a[2];this._annActiveColor[3]=a[3];this._ssGlobal.getUniform("annActiveColor").setFloat4(this._annActiveColor)},setDIMweight:function(a){this._DIMweight=
a},goNextDPFinView:function(a){if(!(2>this.getNumDPFs())){var b=this._inviewDPFid;0>b||(a=void 0===a?1:a,this.requestTransitionToDPF(this.getDPF(b),a))}},_triggerAnnSelect:function(){if(void 0!==this._activeDPF&&0!==this._hoverAnn){if(void 0!==this.onSelectAnnotation)this.onSelectAnnotation();var a=this._activeDPF._annotationList[this._hoverAnn];if(void 0!==a&&void 0!==a.onSelect)a.onSelect()}},_attachListeners:function(){var a=this,b=function(b){b=a._fov+b;120<b&&(b=120);20>b&&(b=20);a.setFOV(b)};
$(function(){$(document).keydown(function(c){32==c.keyCode&&a.home();107==c.keyCode&&(a._vrState||b(.5));109==c.keyCode&&(a._vrState||b(-.5));86==c.keyCode&&a.toggleVR();73==c.keyCode&&void 0!==a._activeDPF&&a._activeDPF.toggleInvertDepth();75==c.keyCode&&void 0!==a._activeDPF&&a.toggleDepthVision();81==c.keyCode&&void 0!==a._activeDPF&&a._activeDPF.toggleQuadraticDepth();80==c.keyCode&&void 0!==a._activeDPF&&a._activeDPF.playOrPauseVideoStreams();88==c.keyCode&&a.toggleDebugCam();102==c.keyCode&&
a.goNextDPFinView(1)})});Hammer(a._canvas).on("tap",function(b){a._useMobile||a._triggerAnnSelect()});Hammer(a._canvas).on("doubletap",function(b){a.goNextDPFinView(1);a._useMobile&&a._triggerAnnSelect()});var c=function(b){var c=a._canvas.width/a._canvas.clientWidth*b.clientX;b=a._canvas.height/a._canvas.clientHeight*(a._canvas.clientHeight-b.clientY);c/=a._canvas.width;b/=a._canvas.height;a._annXYquery[0]=c;a._annXYquery[1]=b};a._bDragging=!1;a._bPointerDown=!1;var d=function(b){a._bDragging=!1;
a._bPointerDown=!0;c(b)},e=function(b){a._bPointerDown&&(a._bDragging=!0);a._useMobile||a._vrState||a._useDeviceOrientation||c(b)},f=function(b){a._bDragging=!1;a._bPointerDown=!1},h=function(b){a._bDragging=!1;a._bPointerDown=!1};a._canvas.addEventListener("pointerdown",d);a._canvas.addEventListener("pointermove",e);a._canvas.addEventListener("pointerup",f);a._canvas.addEventListener("pointerout",h);a._canvas.addEventListener("mousedown",d);a._canvas.addEventListener("mousemove",e);a._canvas.addEventListener("mouseup",
f);a._canvas.addEventListener("mouseout",h);d=new DPFupdateCallback(a);a._root.addUpdateCallback(d)},preloadAll:function(){for(var a=0;a<this._dpfList.length;a++)this._preloadDPF(this._dpfList[a])},_create3Dpointer:function(){this._hoverAnnDepth=1;this._pointerModel=osg.createTexturedSphere(.03,20,20);var a=new osg.Material;a.setTransparency(1);a.setDiffuse([1,1,1,1]);this._pointerModel.getOrCreateStateSet().setAttributeAndModes(a);this._pointerModel.getOrCreateStateSet().setTextureAttributeAndModes(0,
DPFutils.fallbackWhiteTex);this._pointerModel.getOrCreateStateSet().setRenderingHint("TRANSPARENT_BIN");this._pointerModel.getOrCreateStateSet().setBinNumber(12);this._pointerModel.getOrCreateStateSet().setAttributeAndModes(new osg.BlendFunc,osg.StateAttribute.ON);this._pointerTrans=new osg.AutoTransform;this._pointerTrans.setPosition([0,0,0]);this._pointerTrans.setAutoRotateToScreen(!0);this._pointerTrans.addChild(this._pointerModel);this._pointerPos=osg.vec3.create();this._dpfGroup.addChild(this._pointerTrans);
this._pointerTrans.setNodeMask(0)},_createInsightPointer:function(){this._insightModel=osg.createTexturedSphere(.1,20,20);var a=new osg.Material;a.setTransparency(1);a.setDiffuse([0,1,0,1]);this._insightModel.getOrCreateStateSet().setAttributeAndModes(a);this._insightModel.getOrCreateStateSet().setTextureAttributeAndModes(0,DPFutils.fallbackWhiteTex);this._insightModel.getOrCreateStateSet().setRenderingHint("TRANSPARENT_BIN");this._insightModel.getOrCreateStateSet().setAttributeAndModes(new osg.BlendFunc,
osg.StateAttribute.ON);this._insightModel.getOrCreateStateSet().setAttributeAndModes(new osg.Depth(osg.Depth.ALWAYS),osg.StateAttribute.OVERRIDE|osg.StateAttribute.ON);this._insightTrans=new osg.AutoTransform;this._insightTrans.setPosition([0,0,0]);this._insightTrans.setAutoRotateToScreen(!0);this._insightTrans.addChild(this._insightModel);this._dpfGroup.addChild(this._insightTrans);this._insightTrans.setNodeMask(0)},_update3Dpointer:function(){this._pointerPos[0]=this._hoverAnnDepth*this._direction[0];
this._pointerPos[1]=this._hoverAnnDepth*this._direction[1];this._pointerPos[2]=this._hoverAnnDepth*this._direction[2];this._pointerPos[0]+=this._eyePos[0];this._pointerPos[1]+=this._eyePos[1];this._pointerPos[2]+=this._eyePos[2];this._pointerTrans.setPosition(this._pointerPos)},_updateInsightDPF:function(){var a=this._dpfList[this._inviewDPFid];void 0!==a&&(this._preloadDPF(a),this._insightTrans.setPosition(a._position),this._insightTrans.setNodeMask(15))},initRTT:function(){if(void 0!==this._viewer.getCamera()){this._aRTT=
new osg.Camera;this._aRTT.addChild(this._annVisionGroup);this._aRTT.setName("rttCamera");this._aRTT.setClearColor(osg.vec4.create([0,0,0,1]));this._aRTT.setViewMatrix(this._viewer.getCamera().getViewMatrix());this._aRTT.setProjectionMatrix(this._viewer.getCamera().getProjectionMatrix());this._aRTT.setRenderOrder(osg.Camera.PRE_RENDER,0);this._aRTT.setReferenceFrame(osg.Transform.ABSOLUTE_RF);this._aRTT.setViewport(new osg.Viewport(0,0,this._aRTTsize[0],this._aRTTsize[1]));this._aRTTttex=new osg.Texture;
this._aRTTttex.setTextureSize(this._aRTTsize[0],this._aRTTsize[1]);this._aRTTttex.setInternalFormat(osg.Texture.RGB);this._aRTTttex.setMinFilter("NEAREST");this._aRTTttex.setMagFilter("NEAREST");this._aRTT.attachTexture(osg.FrameBufferObject.COLOR_ATTACHMENT0,this._aRTTttex);this._aRTT.attachRenderBuffer(osg.FrameBufferObject.DEPTH_ATTACHMENT,osg.FrameBufferObject.DEPTH_COMPONENT16);this._aRTTquad=osg.createTexturedQuadGeometry(5,50,0,this._aRTTsize[0],0,0,0,this._aRTTsize[1],0);this._aRTTquad.getOrCreateStateSet().setTextureAttributeAndModes(0,
this._aRTTttex);this._root.addChild(this._aRTT);var a=this;a._aRTTcanvasElem=document.createElement("canvas");a._aRTTctx=a._aRTTcanvasElem.getContext("2d");a._aRTTcanvasElem.width=a._aRTTsize[0];a._aRTTcanvasElem.height=a._aRTTsize[1];var b=4*a._aRTTcanvasElem.width;a._aRTTpixels=new Uint8Array(b*a._aRTTcanvasElem.height);var c=a._useMobile?.3:.05,d=void 0;a._tLastRTT=0;a._aRTT.setFinalDrawCallback(function(e){if(a._aEnabled&&!a._bDepthVision&&a._bRTTcanRead&&!(a._time-a._tLastRTT<c||a._bDragging)&&
(d=e.getGraphicContext(),d.checkFramebufferStatus(d.FRAMEBUFFER)===d.FRAMEBUFFER_COMPLETE)){d.readPixels(0,0,a._aRTTcanvasElem.width,a._aRTTcanvasElem.height,d.RGBA,d.UNSIGNED_BYTE,a._aRTTpixels);a._tLastRTT=a._time;var f=Math.floor(a._aRTTcanvasElem.height*a._annXYquery[1])*b+4*Math.floor(a._aRTTcanvasElem.width*a._annXYquery[0]);e=a._aRTTpixels[f];f=a._aRTTpixels[f+1];a._activeDPF&&(a._dNorm=f/255,f=a._activeDPF.getDepthRange(),a._hoverAnnDepth=DPFutils.lerp(f[1],f[0],a._dNorm),a._hoverAnnDepth-=
f[0]);e=Math.floor(e*DPF_ANN_HASH);e!==a._hoverAnn&&(a._hoverAnn=e,a._onChangeAnnotation())}})}},getHoveredAnnotationID:function(){return this._hoverAnn},_onChangeAnnotation:function(){this._ssGlobal.getUniform("annotationHash").setInt(this._hoverAnn);if(0<this._hoverAnn){if(void 0!==this.onHoverAnnotation)this.onHoverAnnotation();var a=this._activeDPF._annotationList[this._hoverAnn];if(void 0!==a&&void 0!==a.onHover)a.onHover();this._vrState||(this._canvas.style.cursor="pointer")}else if(this._vrState||
(this._canvas.style.cursor="auto"),void 0!==this.onLeaveAnnotation)this.onLeaveAnnotation()},initHUD:function(){void 0!==this._canvas&&(this._HUD=new osg.Camera,osg.mat4.ortho(this._HUD.getProjectionMatrix(),0,this._canvas.width,0,this._canvas.height,-5,5),osg.mat4.translate(this._HUD.getViewMatrix(),this._HUD.getViewMatrix(),[25,25,0]),this._HUD.setRenderOrder(osg.Camera.NESTED_RENDER,0),this._HUD.setReferenceFrame(osg.Transform.ABSOLUTE_RF),void 0!==this._aRTTquad&&this._HUD.addChild(this._aRTTquad),
this._root.addChild(this._HUD),this.toggleDebugCam(!1))},toggleDebugCam:function(a){void 0===a?15===this._aRTTquad.getNodeMask()?this._aRTTquad.setNodeMask(0):this._aRTTquad.setNodeMask(15):a?this._aRTTquad.setNodeMask(15):this._aRTTquad.setNodeMask(0)},loadShadersFromPath:function(a,b,c){var d=this;d._shadersPath=a;d._useUnifiedLayout=!1;void 0!==b&&void 0!==b.useUnifiedLayout&&(d._useUnifiedLayout=b.useUnifiedLayout);$.get(a+"/main.glsl",function(a){d._useUnifiedLayout&&(a="#define DPF_USE_UNIFIED 1\n"+
a);d._useMobile&&(a="#define DPF_MOBILE_DEVICE 1\n"+a);a+="\n";a=new osg.Program(new osg.Shader("VERTEX_SHADER","#define VERTEX_SH 1\n"+a),new osg.Shader("FRAGMENT_SHADER","#define FRAGMENT_SH 1\n"+a));d._glslProgram=a;d.onGLSLprogramLoaded();void 0!==c&&c()},"text")},onGLSLprogramLoaded:function(){if(void 0!==this._glslProgram){for(var a=0;a<this._dpfList.length;a++)this._dpfList[a].setGLSLprogram(this._glslProgram),this._useUnifiedLayout&&(this._dpfList[a]._useUnifiedLayout=!0);console.log("GLSL Program Loaded")}},
setupFallbacks:function(){this._stdVisionGroup.getOrCreateStateSet().setTextureAttributeAndModes(DPF_PANO_UNIT,DPFutils.fallbackWhiteTex);this._stdVisionGroup.getOrCreateStateSet().setTextureAttributeAndModes(DPF_DEPTH_UNIT,DPFutils.fallbackBlackTex);this._stdVisionGroup.getOrCreateStateSet().setTextureAttributeAndModes(DPF_ANN_UNIT,DPFutils.fallbackBlackTex);this._annVisionGroup.getOrCreateStateSet().setTextureAttributeAndModes(DPF_PANO_UNIT,DPFutils.fallbackBlackTex);this._annVisionGroup.getOrCreateStateSet().setTextureAttributeAndModes(DPF_DEPTH_UNIT,
DPFutils.fallbackBlackTex);this._annVisionGroup.getOrCreateStateSet().setTextureAttributeAndModes(DPF_ANN_UNIT,DPFutils.fallbackBlackTex);console.log("Fallbacks set")},home:function(){if(0==this._dpfList.length||void 0===this._dpfList[0])this._manip.setEyePosition([0,0,0]),this._manip.setTarget([0,10,0]);else{var a=void 0===this._activeDPF?this._dpfList[0].getPosition():this._activeDPF.getPosition();this._manip.setEyePosition(a)}this._manip.setNode(this._dpfGroup)},goExternalView:function(){if(void 0!==
this._activeDPF){var a=this._activeDPF.getPosition(),b=this._activeDPF.getDepthRange()[1],c=osg.vec3.create();c[0]=a[0]+1*b;c[1]=a[1]+1*b;c[2]=a[2]+.5*b;this._manip.setEyePosition(c);this._manip.setTarget(a)}},setFOV:function(a){this._fov=a;if(void 0!==this._viewer){var b=this._viewer.getCamera();if(void 0!==b){var c={};osg.mat4.getPerspective(c,b.getProjectionMatrix());osg.mat4.perspective(b.getProjectionMatrix(),DPF_DEG2RAD*a,c.aspectRatio,c.zNear,c.zFar)}}},getFOV:function(){return this._fov},
setDOF:function(a){this._DOFweight=a},getDOF:function(){return this._DOFweight},addDPF:function(a){this._dpfList.push(a);this._stdVisionGroup.addChild(a.getTransNode());this._annVisionGroup.addChild(a.getTransNode());void 0!==this._glslProgram&&a.setGLSLprogram(this._glslProgram);console.log("Added new DPF")},getDPF:function(a){return this._dpfList[a]},getDPFbyName:function(a){for(var b=0;b<this._dpfList.length;b++)if(this._dpfList[b]._uniqueName===a)return this._dpfList[b]},getNumDPFs:function(){return this._dpfList.length},
useUnifiedLayout:function(a){this._useUnifiedLayout=a},isUsingUnifiedLayout:function(){return this._useUnifiedLayout},requestTransitionToLocation:function(a,b){0<=this._tMoveReq||(this._tMoveReq=this._time,this._tMoveDur=b,this._reqTo=a,this._reqFrom=this._eyePos)},duringTransition:function(){return 0<=_tMoveReq},requestTransitionToDPF:function(a,b){if(void 0!==this._manip&&void 0!==a){console.log("Requested transition to "+a._uniqueName);if(void 0!==this.onTransitionRequest)this.onTransitionRequest();
void 0===b?this._manip.setEyePosition(a.getPosition()):this.requestTransitionToLocation(a.getPosition(),b)}},requestTransitionToDPFbyIndex:function(a,b){a=this._dpfList[a];void 0!==a&&this.requestTransitionToDPF(a,b)},requestTransitionToDPFbyName:function(a,b){a=this.getDPFbyName(a);void 0!==a&&this.requestTransitionToDPF(a,b)},requestOrientationByDirection:function(a,b,c){this._vrState||(this._manip.setTarget(osg.vec3.fromValues(a,b,c)),console.log("\x3e\x3e\x3e Requested orientation by direction: "+
a+", "+b+", "+c))},requestOrientationToDPF:function(a){void 0!==a&&this.requestOrientationByDirection(a._position[0],a._position[1],a._position[2])},requestOrientationToDPFbyName:function(a){a=this.getDPFbyName(a);this.requestOrientationToDPF(a)},parseXML:function(a,b){var c=a.substring(0,a.lastIndexOf("/")+1),d=void 0,e=void 0,f=void 0,h=this;console.log("Loading XML: "+a+"...");$.get(a,function(a){c+=$(a).find("basepath").text();var g=$(a).find("postfix");void 0!==g&&(void 0!==g.attr("color")&&
(d=g.attr("color")),void 0!==g.attr("depth")&&(e=g.attr("depth")),void 0!==g.attr("annotation")&&(f=g.attr("annotation")));$(a).find("DPF").each(function(a){a=new DPF;h.addDPF(a);console.log("Parsing DPF...");var b=$(this).find("position");void 0!==b.attr("x")&&void 0!==b.attr("y")&&void 0!==b.attr("z")&&a.setPosition([parseFloat(b.attr("x")),parseFloat(b.attr("y")),parseFloat(b.attr("z"))]);b=$(this).find("orientation");void 0!==b.attr("x")&&void 0!==b.attr("y")&&void 0!==b.attr("z")&&a.setOrientationFromEulerVector([parseFloat(b.attr("x")),
parseFloat(b.attr("y")),parseFloat(b.attr("z"))]);b=$(this).find("name");void 0!==b&&(b=b.text(),a.setUniqueName(b),d&&a.setPanoPath(c+b+d,c+"lo_"+b+d),e&&a.setDepthPath(c+b+e),f&&a.setSemanticPath(c+b+f));b=$(this).find("depthrange");void 0!==b&&void 0!==b.attr("min")&&void 0!==b.attr("max")&&a.setDepthRange(parseFloat(b.attr("min")),parseFloat(b.attr("max")))});h.home();void 0!==b&&b()}).fail(function(){console.log("ERROR Loading XML")})},_preloadDPF:function(a){void 0!==a&&(a._bLoaded[0]||a._bLoading[0]||
a.requestPano(),this._useUnifiedLayout||(a._bLoaded[1]||a._bLoading[1]||a.requestDepth(),a._bLoaded[2]||a._bLoading[2]||a.requestSemantic()))},inVRmode:function(){return this._vrState},toggleVR:function(){var a=this._viewer;a.getVRDisplay()?a.setPresentVR(!this._vrState).then(this._switchVR.bind(this)):this._switchVR()},_switchVR:function(){var a=this._viewer;a.setPresentVR(!this._vrState);if(this._vrState)a._eventProxy.WebVR.setEnable(!1),a._eventProxy.DeviceOrientation.setEnable(!1),this._root.removeChild(this._vrNode),
this._root.addChild(this._dpfGroup),this._pointerTrans.setNodeMask(0);else for(this._root.removeChild(this._dpfGroup),this._vrNode||(navigator.getVRDisplays?(a.getEventProxy().WebVR.setEnable(!0),this._vrNode=osgUtil.WebVR.createScene(a,this._dpfGroup,a._eventProxy.WebVR.getHmd())):(a.getEventProxy().DeviceOrientation.setEnable(!0),this._vrNode=osgUtil.WebVRCustom.createScene(a,this._dpfGroup,{isCardboard:!0,vResolution:this._canvas.height,hResolution:this._canvas.width}))),this._root.addChild(this._vrNode),
this._annXYquery=[.5,.5],this._pointerTrans.setNodeMask(15),this.home(),a=0;a<this._vrNode.children.length;a++)this._vrNode.children[a]._nearFarRatio=this._NFR;this._vrState=!this._vrState}};