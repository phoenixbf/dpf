/** @preserve

 	DPF javascript implementation

 	@author Bruno Fanini
	VHLab, CNR ITABC

	When using this JS library, add also reference to EG publication:

	@inproceedings {gch.20161380,
		booktitle = {Eurographics Workshop on Graphics and Cultural Heritage},
		editor = {Chiara Eva Catalano and Livio De Luca},
		title = {{A Framework for Compact and Improved Panoramic VR Dissemination}},
		author = {Fanini, Bruno and D'Annibale, Enzo},
		year = {2016},
		publisher = {The Eurographics Association},
		ISSN = {2312-6124},
		ISBN = {978-3-03868-011-6},
		DOI = {10.2312/gch.20161380}
	}

==================================================================================*/
"use strict";var OSG=window.OSG,osg=OSG.osg;OSG.globalify();const DPF_RAD_SCALE=100,DPF_ANN_HASH=.3,DPF_PANO_UNIT=0,DPF_DEPTH_UNIT=1,DPF_ANN_UNIT=2,DPF_RAD2DEG=180/Math.PI,DPF_DEG2RAD=Math.PI/180,DPF_X_AXIS=[1,0,0],DPF_Y_AXIS=[0,1,0],DPF_Z_AXIS=[0,0,1];var DPFutils={};DPFutils.videoExts=["mp4","avi","ogg","ogv","webm","mpd"],DPFutils.getFileExtension=function(t){return t.substr(t.lastIndexOf(".")+1).toLowerCase()},DPFutils.isURLvideo=function(t){for(var e=this.getFileExtension(t),i=0;i<DPFutils.videoExts.length;i++){var s=DPFutils.videoExts[i];if(e==s.toLowerCase())return!0}return!1},DPFutils.bkIM=new window.Image,DPFutils.bkIM.src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNg+A8AAQIBANEay48AAAAASUVORK5CYII=",DPFutils.wIM=new window.Image,DPFutils.wIM.src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAC0lEQVQIW2P8DwQACgAD/il4QJ8AAAAASUVORK5CYII=",DPFutils.fallbackBlackTex=new osg.Texture,DPFutils.fallbackBlackTex.setImage(DPFutils.bkIM),DPFutils.fallbackBlackTex.setMinFilter(osg.Texture.LINEAR),DPFutils.fallbackBlackTex.setMagFilter(osg.Texture.LINEAR),DPFutils.fallbackBlackTex.setWrapS(osg.Texture.REPEAT),DPFutils.fallbackBlackTex.setWrapT(osg.Texture.REPEAT),DPFutils.fallbackWhiteTex=new osg.Texture,DPFutils.fallbackWhiteTex.setImage(DPFutils.wIM),DPFutils.fallbackWhiteTex.setMinFilter(osg.Texture.LINEAR),DPFutils.fallbackWhiteTex.setMagFilter(osg.Texture.LINEAR),DPFutils.fallbackWhiteTex.setWrapS(osg.Texture.REPEAT),DPFutils.fallbackWhiteTex.setWrapT(osg.Texture.REPEAT),DPFutils.detectMobileDevice=function(){return/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|ipad|iris|kindle|Android|Silk|lge |maemo|midp|mmp|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows (ce|phone)|xda|xiino/i.test(navigator.userAgent)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(navigator.userAgent.substr(0,4))?!0:!1},DPFutils._useMobile=DPFutils.detectMobileDevice();var DPF=function(t,e,i){this._uniqueName="",this._position=[0,0,0],this._mOrient=void 0,this._vOrient=[0,0,0],this._mainTrans=new osg.MatrixTransform,this._glslProgram=void 0,this.initUniforms(),this._useUnifiedLayout=!1,this._panoPath="",this._panoPathLow="",this._depthPath="",this._annPath="",this._isPanoVid=!1,this._isDepthVid=!1,this._isAnnVid=!1,this._panoVidElem=void 0,this._depthVidElem=void 0,this._annVidElem=void 0,this._depthRange={min:0,max:.01},this.setDepthRange(20,20),this._baseGeom=void 0,this._maxBoundSphere=void 0,this._baseGeomResolution=DPFutils._useMobile?40:128,this.realizeBaseSphere(),this._bLoading=[!1,!1,!1],this._annotationList=[],void 0!==t&&this.requestPano(t),void 0!==e&&this.requestDepth(e),void 0!==i&&this.requestSemantic(i)};DPF.prototype={setUniqueName:function(t){this._uniqueName=t},getUniqueName:function(){return this._uniqueName},setPanoPath:function(t,e){this._panoPath=t,void 0!==e&&(this._panoPathLow=e),DPFutils.isURLvideo(t)&&(this._isPanoVid=!0,console.log("Detected pano video stream"))},getPanoPath:function(){return this._panoPath},setDepthPath:function(t){this._depthPath=t,DPFutils.isURLvideo(t)&&(this._isDepthVid=!0,console.log("Detected depth video stream"))},getDepthPath:function(){return this._depthPath},setSemanticPath:function(t){this._annPath=t},getSemanticPath:function(){return this._annPath},isLoading:function(){return this._bLoading[0]||this._bLoading[1]||this._bLoading[2]},setPosition:function(t){this._position=t,this.updateMatrixTransform()},getPosition:function(){return this._position},setOrientationFromQuaternion:function(t){this._orientation=t,this.updateMatrixTransform()},setOrientationFromEulerVector:function(t){this._mOrient=osg.mat4.create();var e=osg.mat4.create();osg.mat4.rotate(e,e,t[0],DPF_X_AXIS);var i=osg.mat4.create();osg.mat4.rotate(i,i,t[1],DPF_Y_AXIS);var s=osg.mat4.create();osg.mat4.rotate(s,s,t[2],DPF_Z_AXIS),this._mOrient=e,osg.mat4.multiply(this._mOrient,this._mOrient,i),osg.mat4.multiply(this._mOrient,this._mOrient,s),this._vOrient[0]=t[0],this._vOrient[1]=t[1],this._vOrient[2]=t[2],this.updateMatrixTransform()},getOrientation:function(){return this._vOrient},getTransNode:function(){return this._mainTrans},setDepthRange:function(t,e){this._depthRange.min=t/DPF_RAD_SCALE,this._depthRange.max=e/DPF_RAD_SCALE,this._mainTrans.getOrCreateStateSet().getUniform("minRad").setFloat(this._depthRange.min),this._mainTrans.getOrCreateStateSet().getUniform("maxRad").setFloat(this._depthRange.max),this._dErr=((e-t)/256).toFixed(3),console.log("- DPF max depth error: "+this._dErr)},getDepthRange:function(){var t=[this._depthRange.min*DPF_RAD_SCALE,this._depthRange.max*DPF_RAD_SCALE];return t},setDepthMultiplier:function(t){this._mainTrans.getOrCreateStateSet().getUniform("radMult").setFloat(t)},getDepthMultiplier:function(){return this._mainTrans.getOrCreateStateSet().getUniform("radMult").getInternalArray()[0]},getDepthErrorAtDistance:function(t){var e=this._depthRange.min*DPF_RAD_SCALE,i=this._depthRange.max*DPF_RAD_SCALE;if(e>=t)return 0;if(t>i)return this._dErr;var s=(t-e)/(i-e),o=this._dErr;return o*=this.getQuadraticDepth()?s*s:s,o.toFixed(6)},setVisibility:function(t){this._mainTrans.getOrCreateStateSet().getUniform("visibility").setFloat(t)},getVisibility:function(){return this._mainTrans.getOrCreateStateSet().getUniform("visibility").getInternalArray()[0]},setDiscardFactor:function(t){this._mainTrans.getOrCreateStateSet().getUniform("slopeDiscard").setFloat(t)},getDiscardFactor:function(){return this._mainTrans.getOrCreateStateSet().getUniform("slopeDiscard").getInternalArray()[0]},setQuadraticDepth:function(t){this._mainTrans.getOrCreateStateSet().getUniform("bQuadratic").setInt(t)},toggleQuadraticDepth:function(){var t=this._mainTrans.getOrCreateStateSet().getUniform("bQuadratic").getInternalArray()[0];this._mainTrans.getOrCreateStateSet().getUniform("bQuadratic").setInt(1===t?0:1)},getQuadraticDepth:function(){return this._mainTrans.getOrCreateStateSet().getUniform("bQuadratic").getInternalArray()[0]},toggleInvertDepth:function(){var t=this._mainTrans.getOrCreateStateSet().getUniform("bInvertDM").getInternalArray()[0];this._mainTrans.getOrCreateStateSet().getUniform("bInvertDM").setInt(1===t?0:1)},getInvertDepth:function(){return this._mainTrans.getOrCreateStateSet().getUniform("bInvertDM").getInternalArray()[0]},setGLSLprogram:function(t){void 0!==t&&(this._glslProgram=t,this._mainTrans.getOrCreateStateSet().setAttributeAndModes(t))},getGLSLprogram:function(){return this._glslProgram},initUniforms:function(){var t=this._mainTrans.getOrCreateStateSet();t.addUniform(osg.Uniform.createFloat1(0,"minRad")),t.addUniform(osg.Uniform.createFloat1(.01,"maxRad")),t.addUniform(osg.Uniform.createFloat1(1,"radMult")),t.addUniform(osg.Uniform.createFloat1(1,"visibility")),t.addUniform(osg.Uniform.createFloat1(0,"slopeDiscard")),t.addUniform(osg.Uniform.createFloat3([0,0,0],"camPos")),t.addUniform(osg.Uniform.createFloat3([0,0,0],"panoPos")),t.addUniform(osg.Uniform.createInt1(1,"bQuadratic")),t.addUniform(osg.Uniform.createInt1(0,"bInvertDM")),t.addUniform(osg.Uniform.createInt1(1,"bActive"))},updateMatrixTransform:function(){var t=osg.mat4.create();osg.mat4.translate(t,t,this._position),void 0!==this._mOrient&&osg.mat4.multiply(t,t,this._mOrient);var e=osg.mat4.create();osg.mat4.fromScaling(e,[DPF_RAD_SCALE,DPF_RAD_SCALE,DPF_RAD_SCALE]),osg.mat4.multiply(t,t,e),console.log("Updated DPF Position: "+this._position),this._mainTrans.setMatrix(t)},realizeBaseSphere:function(){this._mainTrans.setCullingActive(!1),this.updateMatrixTransform(),this._baseGeom=osg.createTexturedSphere(1,this._baseGeomResolution,this._baseGeomResolution),this._baseGeom.setCullingActive(!1),this._baseGeom.getOrCreateStateSet().setAttributeAndModes(new osg.CullFace("DISABLE"));var t=osg.mat4.create();osg.mat4.rotate(t,t,-Math.PI/2,DPF_X_AXIS),this._baseGeomT=new osg.MatrixTransform,this._baseGeomT.setMatrix(t),this._baseGeomT.setCullingActive(!1),this._baseGeomT.addChild(this._baseGeom),this._mainTrans.addChild(this._baseGeomT)},requestPano:function(t){var e=this;if(e._bLoading[0]=!0,void 0!==t&&e.setPanoPath(t),e._isPanoVid){e._panoVidElem=document.createElement("video"),e._panoVidElem.style.display="none";var i=new osg.ImageStream(e._panoVidElem);e._panoVidElem.preload="auto",e._panoVidElem.loop=!0,e._panoVidElem.crossOrigin="anonymous",e._panoVidElem.src=e._panoPath,i.whenReady().then(function(t){var s=new osg.Texture;s.setImage(i),s.setMinFilter(osg.Texture.LINEAR),s.setMagFilter(osg.Texture.LINEAR),s.setWrapS(osg.Texture.REPEAT),s.setWrapT(osg.Texture.CLAMP_TO_EDGE),s.setFlipY(!1),e._mainTrans.getOrCreateStateSet().setTextureAttributeAndModes(DPF_PANO_UNIT,s),console.log("Videopano "+e._panoPath+" loaded."),e._bLoading[0]=!1,t.play()}.bind(e))}else{var s=new osg.Texture,o=function(t,i){osgDB.readImageURL(t).then(function(o){s.setImage(o),s.setMinFilter(osg.Texture.LINEAR_MIPMAP_LINEAR),s.setMagFilter(osg.Texture.LINEAR),s.setWrapS(osg.Texture.REPEAT),s.setWrapT(osg.Texture.CLAMP_TO_EDGE),s.setFlipY(!1),e._mainTrans.getOrCreateStateSet().setTextureAttributeAndModes(DPF_PANO_UNIT,s),console.log("Pano texture "+t+" loaded."),e._bLoading[0]=!1,i()})};o(e._panoPath,function(){e._bLoading[0]=!1})}},requestColor:function(t){return this.requestPano(t)},requestDepth:function(t){if(!this._useUnifiedLayout){var e=this;if(e._bLoading[1]=!0,void 0!==t&&e.setDepthPath(t),e._isDepthVid){e._depthVidElem=document.createElement("video"),e._depthVidElem.style.display="none";var i=new osg.ImageStream(e._depthVidElem);e._depthVidElem.preload="auto",e._depthVidElem.loop=!0,e._depthVidElem.crossOrigin="anonymous",e._depthVidElem.src=e._depthPath,i.whenReady().then(function(t){var s=new osg.Texture;s.setImage(i),s.setMinFilter(osg.Texture.LINEAR),s.setMagFilter(osg.Texture.LINEAR),s.setWrapS(osg.Texture.REPEAT),s.setWrapT(osg.Texture.CLAMP_TO_EDGE),s.setFlipY(!1),e._mainTrans.getOrCreateStateSet().setTextureAttributeAndModes(DPF_DEPTH_UNIT,s),console.log("VideoDepth "+e._depthPath+" loaded."),e._bLoading[1]=!1,t.play()}.bind(e))}else osgDB.readImageURL(e._depthPath).then(function(t){var i=new osg.Texture;i.setImage(t),i.setMinFilter(osg.Texture.LINEAR_MIPMAP_LINEAR),i.setMagFilter(osg.Texture.LINEAR),i.setWrapS(osg.Texture.REPEAT),i.setWrapT(osg.Texture.CLAMP_TO_EDGE),i.setFlipY(!1),e._mainTrans.getOrCreateStateSet().setTextureAttributeAndModes(DPF_DEPTH_UNIT,i),console.log("Depth texture "+e._depthPath+" loaded."),e._bLoading[1]=!1})}},requestSemantic:function(t){if(!this._useUnifiedLayout){var e=this;e._bLoading[2]=!0,void 0!==t&&e.setSemanticPath(t),osgDB.readImageURL(e._annPath).then(function(t){var i=new osg.Texture,s=t.getImage();s.setAttribute("data-pagespeed-no-transform","true"),s.setAttribute("pagespeed-no-transform","true"),i.setImage(t),i.setMinFilter("NEAREST"),i.setMagFilter("NEAREST"),i.setWrapS(osg.Texture.REPEAT),i.setWrapT(osg.Texture.CLAMP_TO_EDGE),i.setFlipY(!1),e._mainTrans.getOrCreateStateSet().setTextureAttributeAndModes(DPF_ANN_UNIT,i),console.log("Annotation texture "+e._annPath+" loaded."),e._bLoading[2]=!1})}},playVideoStreams:function(){void 0!==this._panoVidElem&&this._panoVidElem.play(),void 0!==this._depthVidElem&&this._depthVidElem.play(),void 0!==this._annVidElem&&this._annVidElem.play(),this._isVideoStreamOnPlay=!0},pauseVideoStreams:function(){void 0!==this._panoVidElem&&this._panoVidElem.pause(),void 0!==this._depthVidElem&&this._depthVidElem.pause(),void 0!==this._annVidElem&&this._annVidElem.pause(),this._isVideoStreamOnPlay=!1},isPlayingVideoStreams:function(){return this._isVideoStreamOnPlay},playOrPauseVideoStreams:function(){this._isVideoStreamOnPlay?this.pauseVideoStreams():this.playVideoStreams()},syncVideoStreams:function(){if(void 0!==this._panoVidElem){var t=this._panoVidElem.currentTime;void 0!==this._depthVidElem&&(this._depthVidElem.currentTime=t),void 0!==this._annVidElem&&(this._annVidElem.currentTime=t)}},registerAnnotation:function(t,e,i){var s=new DPFannotation(this,t);void 0!==e&&(s.onHover=e),void 0!==i&&(s.onSelect=i),this._annotationList[t]=s},onHoverAnnotation:function(t,e){void 0===this._annotationList[t]&&(this._annotationList[t]=new DPFannotation(this,t)),this._annotationList[t].onHover=e},onSelectAnnotation:function(t,e){void 0===this._annotationList[t]&&(this._annotationList[t]=new DPFannotation(this,t)),this._annotationList[t].onSelect=e}};var DPFannotation=function(t,e){var i=this;i.dpf=t,i.hashID=e,i.onHover=function(){console.log("Hovering annotation #"+i.hashID)},i.onSelect=function(){console.log("Selected annotation #"+i.hashID)}},DPFupdateCallback=function(t){this._dpfh=t,this._tReqNorm=0,this._vD=osg.vec3.create(),this._vE=osg.vec3.create(),this._focP=osg.vec3.create(),this._distTarg=Number.MAX_VALUE,this._distView=Number.MAX_VALUE,this._bView=!1};DPFupdateCallback.prototype={update:function(t,e){var i=this._dpfh;i._time=e.getFrameStamp().getSimulationTime();var s=i._time-i._time;if(0>s)return!0;if(i._ssGlobal.getUniform("time").setFloat(i._time),i._ssGlobal.getUniform("DOF").setFloat2([i._DOFweight,i._hoverAnnDepth]),0==i._dpfList.length)return!0;i._tDIMreq>0&&i._handleDIM(),i._manip.getEyePosition(i._eyePos),i._manip.getTarget(i._targPos),i._targD2=1e3*osg.vec3.squaredDistance(i._targPos,i._lastTargPos),i._posD2=1e3*osg.vec3.squaredDistance(i._eyePos,i._lastEyePos),i._bRTTcanRead=i._targD2>.002||i._posD2>.002?!1:!0,i._lastTargPos[0]=i._targPos[0],i._lastTargPos[1]=i._targPos[1],i._lastTargPos[2]=i._targPos[2],i._lastEyePos[0]=i._eyePos[0],i._lastEyePos[1]=i._eyePos[1],i._lastEyePos[2]=i._eyePos[2],osg.vec3.sub(i._direction,i._targPos,i._eyePos),osg.vec3.normalize(i._direction,i._direction),osg.vec3.add(i._targPos,i._eyePos,i._direction),i._update3Dpointer(),this._distTarg=Number.MAX_VALUE,this._distView=Number.MAX_VALUE,this._bView=!1;for(var o=i._dpfList.length,a=0;o>a;a++){var n=i._dpfList[a],r=n.getPosition();n.setVisibility(0),osg.vec3.sub(this._vE,i._eyePos,r);var h=osg.vec3.squaredDistance(i._eyePos,r);if(h>1){osg.vec3.normalize(this._vE,this._vE);var _=osg.vec3.dot(i._direction,this._vE);-.8>_&&h<this._distView&&(i._inviewDPFid=a,this._distView=h)}osg.vec3.lerp(this._focP,i._eyePos,i._pointerTrans.getPosition(),.02),osg.vec3.sub(this._vD,this._focP,r);var d=osg.vec3.squaredDistance(this._focP,r);d<this._distTarg&&(this._distTarg=d,i._closestDPF=n,i._closestDPFid=a)}return i._closestDPF.setVisibility(1),i._inviewDPFid>=0&&o>1&&i._updateInsightDPF(),i._tMoveReq>=0&&(this._tReqNorm=(i._time-i._tMoveReq)/i._tMoveDur,this._tReqNorm>=1?(i._tMoveReq=-1,i._eyePos[0]=i._reqTo[0],i._eyePos[1]=i._reqTo[1],i._eyePos[2]=i._reqTo[2],i._targPos[0]=i._eyePos[0]+i._direction[0],i._targPos[1]=i._eyePos[1]+i._direction[1],i._targPos[2]=i._eyePos[2]+i._direction[2],i._inviewDPFid=-1,i._insightTrans.setNodeMask(0)):(this._tReqNorm=(1-Math.cos(this._tReqNorm*Math.PI))/2,osg.vec3.lerp(i._eyePos,i._reqFrom,i._reqTo,this._tReqNorm))),i._manip.setEyePosition(i._eyePos),void 0!==i.onTick&&i.onTick(),!0}};var DPFhandler=function(t,e){if(void 0===t)return void console.log("Canvas not valid");this._canvas=t,this._useMobile=DPFutils._useMobile,this._useDeviceOrientation=!1,this._viewer=void 0===e?void 0:e,this._dpfList=[],this._root=new osg.Node,this._root.setName("root"),this._dpfGroup=new osg.Node,this._stdVisionGroup=new osg.Node,this._annVisionGroup=new osg.Node,this._stdVisionGroup.getOrCreateStateSet().setAttributeAndModes(new osg.CullFace(osg.CullFace.FRONT),osg.StateAttribute.ON|osg.StateAttribute.OVERRIDE),this._stdVisionGroup.getOrCreateStateSet().setAttributeAndModes(new osg.Depth(osg.Depth.ENABLE),osg.StateAttribute.ON|osg.StateAttribute.OVERRIDE),this._stdVisionGroup.getOrCreateStateSet().setAttributeAndModes(new osg.BlendFunc,osg.StateAttribute.ON|osg.StateAttribute.OVERRIDE),this._stdVisionGroup.getOrCreateStateSet().setRenderingHint("TRANSPARENT_BIN"),this._annVisionGroup.getOrCreateStateSet().setAttributeAndModes(new osg.Depth(osg.Depth.ENABLE),osg.StateAttribute.ON|osg.StateAttribute.OVERRIDE),this._annVisionGroup.getOrCreateStateSet().setAttributeAndModes(new osg.CullFace(osg.CullFace.FRONT),osg.StateAttribute.ON|osg.StateAttribute.OVERRIDE),this._annVisionGroup.getOrCreateStateSet().setAttributeAndModes(new osg.BlendFunc,osg.StateAttribute.OFF|osg.StateAttribute.OVERRIDE),this._annVisionGroup.getOrCreateStateSet().setRenderingHint("OPAQUE_BIN"),this.setupFallbacks(),this._dpfGroup.addChild(this._stdVisionGroup),this._initGlobalUniforms(),this.resetDIM(),this._annXYquery=[.5,.5],this._create3Dpointer(),this._bRTTcanRead=!0,this.onHoverAnnotation=void 0,this.onLeaveAnnotation=void 0,this.onSelectAnnotation=void 0,this._createInsightPointer(),this.onTick=void 0,this._root.addChild(this._dpfGroup),this._shadersPath=void 0,this._glslProgram=void 0,this._manip=new osgGA.FirstPersonManipulator,this._manip.setNode(this._dpfGroup),this._manip.setEyePosition(osg.vec3.fromValues(0,0,0)),this._manip.setTarget(osg.vec3.fromValues(0,1,0));var i=.5;this._manip._stepFactor=i,this._manip.setStepFactor(i),this._manip.computeHomePosition=function(){},this._eyePos=osg.vec3.fromValues(0,0,0),this._targPos=osg.vec3.fromValues(0,1,0),this._direction=osg.vec3.fromValues(0,1,0),this._fov=60,this._lastTargPos=osg.vec3.fromValues(0,0,0),this._lastEyePos=osg.vec3.fromValues(0,0,0),this._reqFrom=osg.vec3.create(),this._reqTo=osg.vec3.create(),this._tMoveReq=-1,this._tMoveDur=3,this._closestDPF=void 0,this._closestDPFid=-1,this._inviewDPFid=-1,this._vrState=!1,this._vrNode=void 0};DPFhandler.prototype={_initGlobalUniforms:function(){this._ssGlobal=this._dpfGroup.getOrCreateStateSet(),this._ssVis=this._stdVisionGroup.getOrCreateStateSet(),this._ssAnn=this._annVisionGroup.getOrCreateStateSet(),this._DIMweight=0,this._DIMcolor=osg.vec4.fromValues(0,0,0,this._DIMweight),this._tDIMdur=1,this._DOFweight=0,this._useUnifiedLayout=!1,this._ssGlobal.addUniform(osg.Uniform.createInt1(DPF_PANO_UNIT,"panoTex")),this._ssGlobal.addUniform(osg.Uniform.createInt1(DPF_DEPTH_UNIT,"depthTex")),this._ssGlobal.addUniform(osg.Uniform.createInt1(DPF_ANN_UNIT,"annTex")),this._ssGlobal.addUniform(osg.Uniform.createFloat1(0,"time")),this._ssGlobal.addUniform(osg.Uniform.createInt1(0,"annotationHash")),this._ssGlobal.addUniform(osg.Uniform.createInt1(0,"bDepthVision")),this._ssGlobal.addUniform(osg.Uniform.createFloat4(this._DIMcolor,"dimColor")),this._ssGlobal.addUniform(osg.Uniform.createFloat2([this._DOFweight,0],"DOF")),this._ssVis.addUniform(osg.Uniform.createInt1(0,"bAnnotationVision")),this._ssAnn.addUniform(osg.Uniform.createInt1(1,"bAnnotationVision"))},run:function(){return void 0===this._canvas?void console.log("ERROR: you must provide a canvas element"):(void 0===this._viewer&&(this._viewer=new osgViewer.Viewer(this._canvas,{antialias:!1,enableFrustumCulling:!1,alpha:!0})),this._viewer.init(),this._viewer.setLightingMode(osgViewer.View.LightingMode.NO_LIGHT),this._viewer.setSceneData(this._root),this._viewer.setManipulator(this._manip),this._manip.setNode(this._dpfGroup),this.setFOV(this._fov),this._viewer.run(),this._NFR=3e-4,this._viewer.getCamera().setNearFarRatio(this._NFR),this._aRTTsize=[256,256],this._hoverAnn=0,this.initRTT(),this.initHUD(),this._time=0,void this._attachListeners())},useDeviceOrientation:function(t){void 0!==this._viewer&&(this._useDeviceOrientation=t,this._viewer.getEventProxy().DeviceOrientation.setEnable(t),t&&(this._annXYquery=[.5,.5]))},toggleDepthVision:function(){var t=this._ssGlobal.getUniform("bDepthVision").getInternalArray()[0];this._ssGlobal.getUniform("bDepthVision").setInt(1===t?0:1)},_handleDIM:function(){return this._tDIM=(this._time-this._tDIMreq)/this._tDIMdur,this._tDIM>=1?(this._tDIMreq=-1,this._DIMcolor[3]=this._DIMweight,void this._ssGlobal.getUniform("dimColor").setFloat4(this._DIMcolor)):(this._DIMcolor[3]=this._DIMweight*this._tDIM,void this._ssGlobal.getUniform("dimColor").setFloat4(this._DIMcolor))},requestDIManimation:function(){this._DIMweight<=0||(this._tDIMreq=this._time)},resetDIM:function(){this._tDIMreq=-1,this._DIMcolor[3]=0,this._ssGlobal.getUniform("dimColor").setFloat4(this._DIMcolor)},setDIMcolor:function(t){this._DIMcolor[0]=t[0],this._DIMcolor[1]=t[1],this._DIMcolor[2]=t[2]},setDIMweight:function(t){this._DIMweight=t},goNextDPFinView:function(t){if(!(this.getNumDPFs()<2)){var e=this._inviewDPFid;if(!(0>e)){var i=void 0===t?1:t;this.requestTransitionToDPF(this.getDPF(e),i)}}},_triggerAnnSelect:function(){if(void 0!==this._closestDPF&&0!==this._hoverAnn){void 0!==this.onSelectAnnotation&&this.onSelectAnnotation();var t=this._closestDPF._annotationList[this._hoverAnn];void 0!==t&&void 0!==t.onSelect&&t.onSelect()}},_attachListeners:function(){var t=this,e=function(e){var i=t._fov+e;i>120&&(i=120),20>i&&(i=20),t.setFOV(i)};$(function(){$(document).keydown(function(i){32==i.keyCode&&t.home(),107==i.keyCode&&(t._vrState||e(.5)),109==i.keyCode&&(t._vrState||e(-.5)),86==i.keyCode&&t.toggleVR(),73==i.keyCode&&void 0!==t._closestDPF&&t._closestDPF.toggleInvertDepth(),75==i.keyCode&&void 0!==t._closestDPF&&t.toggleDepthVision(),81==i.keyCode&&void 0!==t._closestDPF&&t._closestDPF.toggleQuadraticDepth(),80==i.keyCode&&void 0!==t._closestDPF&&t._closestDPF.playOrPauseVideoStreams(),88==i.keyCode&&t.toggleDebugCam(),102==i.keyCode&&t.goNextDPFinView(1)})}),Hammer(t._canvas).on("tap",function(){t._useMobile||t._triggerAnnSelect()}),Hammer(t._canvas).on("doubletap",function(){t.goNextDPFinView(1),t._useMobile&&t._triggerAnnSelect()});var i=function(e){var i=e.clientX*(t._canvas.width/t._canvas.clientWidth),s=(t._canvas.clientHeight-e.clientY)*(t._canvas.height/t._canvas.clientHeight);i/=t._canvas.width,s/=t._canvas.height,t._annXYquery[0]=i,t._annXYquery[1]=s};t._bDragging=!1,t._bPointerDown=!1;var s=function(e){t._bDragging=!1,t._bPointerDown=!0,i(e)},o=function(e){t._bPointerDown&&(t._bDragging=!0),t._useMobile||t._vrState||t._useDeviceOrientation||i(e)},a=function(){t._bDragging=!1,t._bPointerDown=!1},n=function(){t._bDragging=!1,t._bPointerDown=!1};t._canvas.addEventListener("pointerdown",s),t._canvas.addEventListener("pointermove",o),t._canvas.addEventListener("pointerup",a),t._canvas.addEventListener("pointerout",n),t._canvas.addEventListener("mousedown",s),t._canvas.addEventListener("mousemove",o),t._canvas.addEventListener("mouseup",a),t._canvas.addEventListener("mouseout",n);var r=new DPFupdateCallback(t);t._dpfGroup.addUpdateCallback(r)},_create3Dpointer:function(){var t=this;t._hoverAnnDepth=1,this._pointerModel=osg.createTexturedSphere(.03,20,20);var e=new osg.Material;e.setTransparency(1),e.setDiffuse([1,1,1,1]),this._pointerModel.getOrCreateStateSet().setAttributeAndModes(e),this._pointerModel.getOrCreateStateSet().setTextureAttributeAndModes(0,DPFutils.fallbackWhiteTex),this._pointerModel.getOrCreateStateSet().setRenderingHint("TRANSPARENT_BIN"),this._pointerModel.getOrCreateStateSet().setBinNumber(12),this._pointerModel.getOrCreateStateSet().setAttributeAndModes(new osg.BlendFunc,osg.StateAttribute.ON),t._pointerTrans=new osg.AutoTransform,t._pointerTrans.setPosition([0,0,0]),t._pointerTrans.setAutoRotateToScreen(!0),t._pointerTrans.addChild(t._pointerModel),t._pointerPos=osg.vec3.create(),t._dpfGroup.addChild(t._pointerTrans),t._pointerTrans.setNodeMask(0)},_createInsightPointer:function(){this._insightModel=osg.createTexturedSphere(.1,20,20);var t=new osg.Material;t.setTransparency(1),t.setDiffuse([0,1,0,1]),this._insightModel.getOrCreateStateSet().setAttributeAndModes(t),this._insightModel.getOrCreateStateSet().setTextureAttributeAndModes(0,DPFutils.fallbackWhiteTex),this._insightModel.getOrCreateStateSet().setRenderingHint("TRANSPARENT_BIN"),this._insightModel.getOrCreateStateSet().setAttributeAndModes(new osg.BlendFunc,osg.StateAttribute.ON),this._insightModel.getOrCreateStateSet().setAttributeAndModes(new osg.Depth(osg.Depth.ALWAYS),osg.StateAttribute.OVERRIDE|osg.StateAttribute.ON),this._insightTrans=new osg.AutoTransform,this._insightTrans.setPosition([0,0,0]),this._insightTrans.setAutoRotateToScreen(!0),this._insightTrans.addChild(this._insightModel),this._dpfGroup.addChild(this._insightTrans),this._insightTrans.setNodeMask(0)},_update3Dpointer:function(){this._pointerPos[0]=this._hoverAnnDepth*this._direction[0],this._pointerPos[1]=this._hoverAnnDepth*this._direction[1],this._pointerPos[2]=this._hoverAnnDepth*this._direction[2],this._pointerPos[0]=this._pointerPos[0]+this._eyePos[0],this._pointerPos[1]=this._pointerPos[1]+this._eyePos[1],this._pointerPos[2]=this._pointerPos[2]+this._eyePos[2],this._pointerTrans.setPosition(this._pointerPos)},_updateInsightDPF:function(){var t=this._dpfList[this._inviewDPFid];void 0!==t&&(this._insightTrans.setPosition(t._position),this._insightTrans.setNodeMask(15))},initRTT:function(){if(void 0!==this._viewer.getCamera()){this._aRTT=new osg.Camera,this._aRTT.addChild(this._annVisionGroup),this._aRTT.setName("rttCamera"),this._aRTT.setClearColor(osg.vec4.create([0,0,0,1])),this._aRTT.setViewMatrix(this._viewer.getCamera().getViewMatrix()),this._aRTT.setProjectionMatrix(this._viewer.getCamera().getProjectionMatrix()),this._aRTT.setRenderOrder(osg.Camera.PRE_RENDER,0),this._aRTT.setReferenceFrame(osg.Transform.ABSOLUTE_RF),this._aRTT.setViewport(new osg.Viewport(0,0,this._aRTTsize[0],this._aRTTsize[1])),this._aRTTttex=new osg.Texture,this._aRTTttex.setTextureSize(this._aRTTsize[0],this._aRTTsize[1]),this._aRTTttex.setInternalFormat(osg.Texture.RGB),this._aRTTttex.setMinFilter("NEAREST"),this._aRTTttex.setMagFilter("NEAREST"),this._aRTT.attachTexture(osg.FrameBufferObject.COLOR_ATTACHMENT0,this._aRTTttex),this._aRTT.attachRenderBuffer(osg.FrameBufferObject.DEPTH_ATTACHMENT,osg.FrameBufferObject.DEPTH_COMPONENT16),this._aRTTquad=osg.createTexturedQuadGeometry(5,50,0,this._aRTTsize[0],0,0,0,this._aRTTsize[1],0),this._aRTTquad.getOrCreateStateSet().setTextureAttributeAndModes(0,this._aRTTttex),this._root.addChild(this._aRTT);var t=this;t._aRTTcanvasElem=document.createElement("canvas"),t._aRTTctx=t._aRTTcanvasElem.getContext("2d"),t._aRTTcanvasElem.width=t._aRTTsize[0],t._aRTTcanvasElem.height=t._aRTTsize[1];var e=4*t._aRTTcanvasElem.width,i=(4*t._aRTTcanvasElem.height,e*t._aRTTcanvasElem.height);t._aRTTpixels=new Uint8Array(i);var s=t._useMobile?.3:.05,o=void 0;t._tLastRTT=0;var a=function(i){if(t._bRTTcanRead&&!(t._time-t._tLastRTT<s||t._bDragging||(o=i.getGraphicContext(),o.checkFramebufferStatus(o.FRAMEBUFFER)!==o.FRAMEBUFFER_COMPLETE))){o.readPixels(0,0,t._aRTTcanvasElem.width,t._aRTTcanvasElem.height,o.RGBA,o.UNSIGNED_BYTE,t._aRTTpixels),t._tLastRTT=t._time;var a=Math.floor(t._aRTTcanvasElem.width*t._annXYquery[0]),n=Math.floor(t._aRTTcanvasElem.height*t._annXYquery[1]),r=n*e+4*a,h=t._aRTTpixels[r],_=t._aRTTpixels[r+1];if(t._closestDPF){var d=_/255,g=t._closestDPF.getDepthRange();t._hoverAnnDepth=g[1]+d*(g[0]-g[1])-g[0]}var l=Math.floor(h*DPF_ANN_HASH);l!==t._hoverAnn&&(t._hoverAnn=l,t._onChangeAnnotation())}};t._aRTT.setFinalDrawCallback(a)}},getHoveredAnnotationID:function(){return this._hoverAnn},_onChangeAnnotation:function(){if(this._ssGlobal.getUniform("annotationHash").setInt(this._hoverAnn),this._hoverAnn>0){void 0!==this.onHoverAnnotation&&this.onHoverAnnotation();var t=this._closestDPF._annotationList[this._hoverAnn];void 0!==t&&void 0!==t.onHover&&t.onHover(),this._vrState||(this._canvas.style.cursor="pointer")}else this._vrState||(this._canvas.style.cursor="auto"),void 0!==this.onLeaveAnnotation&&this.onLeaveAnnotation()},initHUD:function(){void 0!==this._canvas&&(this._HUD=new osg.Camera,osg.mat4.ortho(this._HUD.getProjectionMatrix(),0,this._canvas.width,0,this._canvas.height,-5,5),osg.mat4.translate(this._HUD.getViewMatrix(),this._HUD.getViewMatrix(),[25,25,0]),this._HUD.setRenderOrder(osg.Camera.NESTED_RENDER,0),this._HUD.setReferenceFrame(osg.Transform.ABSOLUTE_RF),void 0!==this._aRTTquad&&this._HUD.addChild(this._aRTTquad),this._root.addChild(this._HUD),this.toggleDebugCam(!1))},toggleDebugCam:function(t){return void 0===t?void this._aRTTquad.setNodeMask(15===this._aRTTquad.getNodeMask()?0:15):void this._aRTTquad.setNodeMask(t?15:0)},loadShadersFromPath:function(t,e){var i=this;i._shadersPath=t,i._useUnifiedLayout=!1,void 0!==e&&void 0!==e.useUnifiedLayout&&(i._useUnifiedLayout=e.useUnifiedLayout),$.get(t+"/main.glsl",function(t){i._useUnifiedLayout&&(t="#define DPF_USE_UNIFIED 1\n"+t),i._useMobile&&(t="#define DPF_MOBILE_DEVICE 1\n"+t),t+="\n";var e=new osg.Program(new osg.Shader("VERTEX_SHADER","#define VERTEX_SH 1\n"+t),new osg.Shader("FRAGMENT_SHADER","#define FRAGMENT_SH 1\n"+t));i._glslProgram=e,i.onGLSLprogramLoaded()},"text")},onGLSLprogramLoaded:function(){if(void 0!==this._glslProgram){for(var t=0;t<this._dpfList.length;t++)this._dpfList[t].setGLSLprogram(this._glslProgram),this._useUnifiedLayout&&(this._dpfList[t]._useUnifiedLayout=!0);console.log("GLSL Program Loaded")}},setupFallbacks:function(){this._stdVisionGroup.getOrCreateStateSet().setTextureAttributeAndModes(DPF_PANO_UNIT,DPFutils.fallbackWhiteTex),this._stdVisionGroup.getOrCreateStateSet().setTextureAttributeAndModes(DPF_DEPTH_UNIT,DPFutils.fallbackBlackTex),this._stdVisionGroup.getOrCreateStateSet().setTextureAttributeAndModes(DPF_ANN_UNIT,DPFutils.fallbackBlackTex),this._annVisionGroup.getOrCreateStateSet().setTextureAttributeAndModes(DPF_PANO_UNIT,DPFutils.fallbackBlackTex),this._annVisionGroup.getOrCreateStateSet().setTextureAttributeAndModes(DPF_DEPTH_UNIT,DPFutils.fallbackBlackTex),this._annVisionGroup.getOrCreateStateSet().setTextureAttributeAndModes(DPF_ANN_UNIT,DPFutils.fallbackBlackTex),console.log("Fallbacks set")},home:function(){if(0==this._dpfList.length||void 0===this._dpfList[0])return this._manip.setEyePosition([0,0,0]),this._manip.setTarget([0,10,0]),void this._manip.setNode(this._dpfGroup);var t;t=void 0===this._closestDPF?this._dpfList[0].getPosition():this._closestDPF.getPosition(),this._manip.setEyePosition(t),this._manip.setNode(this._dpfGroup)},goExternalView:function(){if(void 0!==this._closestDPF){var t=this._closestDPF.getPosition(),e=this._closestDPF.getDepthRange()[1],i=osg.vec3.create();i[0]=t[0]+1*e,i[1]=t[1]+1*e,i[2]=t[2]+.5*e,this._manip.setEyePosition(i),this._manip.setTarget(t)}},setFOV:function(t){if(this._fov=t,void 0!==this._viewer){var e=this._viewer.getCamera();if(void 0!==e){var i={};osg.mat4.getPerspective(i,e.getProjectionMatrix()),
osg.mat4.perspective(e.getProjectionMatrix(),DPF_DEG2RAD*t,i.aspectRatio,i.zNear,i.zFar)}}},getFOV:function(){return this._fov},setDOF:function(t){this._DOFweight=t},getDOF:function(){return this._DOFweight},addDPF:function(t){this._dpfList.push(t),this._stdVisionGroup.addChild(t.getTransNode()),this._annVisionGroup.addChild(t.getTransNode()),void 0!==this._glslProgram&&t.setGLSLprogram(this._glslProgram),console.log("Added new DPF")},getDPF:function(t){return this._dpfList[t]},getDPFbyName:function(t){for(var e=0;e<this._dpfList.length;e++)if(this._dpfList[e]._uniqueName===t)return this._dpfList[e];return void 0},getNumDPFs:function(){return this._dpfList.length},useUnifiedLayout:function(t){this._useUnifiedLayout=t},isUsingUnifiedLayout:function(){return this._useUnifiedLayout},requestTransitionToLocation:function(t,e){this._tMoveReq>=0||(this._tMoveReq=this._time,this._tMoveDur=e,this._reqTo=t,this._reqFrom=this._eyePos)},duringTransition:function(){return _tMoveReq>=0},requestTransitionToDPF:function(t,e){void 0!==this._manip&&void 0!==t&&(void 0===e?this._manip.setEyePosition(t.getPosition()):this.requestTransitionToLocation(t.getPosition(),e))},requestTransitionToDPFbyIndex:function(t,e){var i=this._dpfList[t];void 0!==i&&this.requestTransitionToDPF(i,e)},requestTransitionToDPFbyName:function(t,e){var i=this.getDPFbyName(t);void 0!==i&&this.requestTransitionToDPF(i,e)},parseXML:function(t,e){var i=t.substring(0,t.lastIndexOf("/")+1),s=".jpg",o="-d.png",a="-a.png",n=this;console.log("Loading XML: "+t+"..."),$.get(t,function(t){i+=$(t).find("basepath").text();var r=$(t).find("postfix");void 0!==r&&(void 0!==r.attr("color")&&(s=r.attr("color")),void 0!==r.attr("depth")&&(o=r.attr("depth")),void 0!==r.attr("annotation")&&(a=r.attr("annotation"))),$(t).find("DPF").each(function(){var t=new DPF;n.addDPF(t),console.log("Parsing DPF...");var e=$(this).find("position");void 0!==e.attr("x")&&void 0!==e.attr("y")&&void 0!==e.attr("z")&&t.setPosition([parseFloat(e.attr("x")),parseFloat(e.attr("y")),parseFloat(e.attr("z"))]);var r=$(this).find("orientation");void 0!==r.attr("x")&&void 0!==r.attr("y")&&void 0!==r.attr("z")&&t.setOrientationFromEulerVector([parseFloat(r.attr("x")),parseFloat(r.attr("y")),parseFloat(r.attr("z"))]);var h=$(this).find("name");if(void 0!==h){var _=h.text();t.setUniqueName(_),t.setPanoPath(i+_+s,i+"lo_"+_+s),t.setDepthPath(i+_+o),t.setSemanticPath(i+_+a)}var d=$(this).find("depthrange");void 0!==d&&void 0!==d.attr("min")&&void 0!==d.attr("max")&&t.setDepthRange(parseFloat(d.attr("min")),parseFloat(d.attr("max")))});for(var h=0;h<n._dpfList.length;h++)n.getDPF(h).requestPano(),n._useUnifiedLayout||(n.getDPF(h).requestDepth(),n.getDPF(h).requestSemantic());n.home(),void 0!==e&&e()}).fail(function(){console.log("ERROR Loading XML")})},inVRmode:function(){return this._vrState},toggleVR:function(){var t=this._viewer;t.getVRDisplay()?t.setPresentVR(!this._vrState).then(this._switchVR.bind(this)):this._switchVR()},_switchVR:function(){var t=this._viewer;if(t.setPresentVR(!this._vrState),this._vrState)t._eventProxy.WebVR.setEnable(!1),t._eventProxy.DeviceOrientation.setEnable(!1),this._root.removeChild(this._vrNode),this._root.addChild(this._dpfGroup),this._pointerTrans.setNodeMask(0);else{this._root.removeChild(this._dpfGroup),this._vrNode||(navigator.getVRDisplays?(t.getEventProxy().WebVR.setEnable(!0),this._vrNode=osgUtil.WebVR.createScene(t,this._dpfGroup,t._eventProxy.WebVR.getHmd())):(t.getEventProxy().DeviceOrientation.setEnable(!0),this._vrNode=osgUtil.WebVRCustom.createScene(t,this._dpfGroup,{isCardboard:!0,vResolution:this._canvas.height,hResolution:this._canvas.width}))),this._root.addChild(this._vrNode),this._annXYquery=[.5,.5],this._pointerTrans.setNodeMask(15),this.home();for(var e=0;e<this._vrNode.children.length;e++)this._vrNode.children[e]._nearFarRatio=this._NFR}this._vrState=!this._vrState}};